<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>python协程 | 兼一书虫</title><meta name="keywords" content="python,协程,异步,迭代器,itertools,yield,asyncio"><meta name="author" content="narutohyc"><meta name="copyright" content="narutohyc"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="python迭代对象扫描内存中放不下的数据集时，我们要找到一种惰性获取数据项的方式，即按需一次获取一个数据项 这就是迭代器模式（Iterator pattern），迭代是数据处理的基石  Python 2.2（2001 年）加入了 yield 关键字。这个关键字用于构建生成器（generator），其作用与迭代器一样。   所有生成器都是迭代器，因为生成器完全实现了迭代器接口。 迭代器用于从集合">
<meta property="og:type" content="article">
<meta property="og:title" content="python协程">
<meta property="og:url" content="https://hycbook.github.io/hycBlog/article/56863.html">
<meta property="og:site_name" content="兼一书虫">
<meta property="og:description" content="python迭代对象扫描内存中放不下的数据集时，我们要找到一种惰性获取数据项的方式，即按需一次获取一个数据项 这就是迭代器模式（Iterator pattern），迭代是数据处理的基石  Python 2.2（2001 年）加入了 yield 关键字。这个关键字用于构建生成器（generator），其作用与迭代器一样。   所有生成器都是迭代器，因为生成器完全实现了迭代器接口。 迭代器用于从集合">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://images5.alphacoders.com/729/729952.png">
<meta property="article:published_time" content="2022-09-10T12:46:25.000Z">
<meta property="article:modified_time" content="2022-09-19T13:48:24.667Z">
<meta property="article:author" content="narutohyc">
<meta property="article:tag" content="python">
<meta property="article:tag" content="协程">
<meta property="article:tag" content="异步">
<meta property="article:tag" content="迭代器">
<meta property="article:tag" content="itertools">
<meta property="article:tag" content="yield">
<meta property="article:tag" content="asyncio">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://images5.alphacoders.com/729/729952.png"><link rel="shortcut icon" href="/img/%E7%BD%91%E7%AB%99%E5%9B%BE%E6%A0%87.ico"><link rel="canonical" href="https://hycbook.github.io/hycBlog/article/56863"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"IMKX0J251S","apiKey":"92de3dc43df2b8318c81df68e94d2221","indexName":"hexo_book","hits":{"per_page":10},"languages":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}.","hits_stats":"${hits} results found in ${time} ms"}},
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":120,"languages":{"author":"Author: narutohyc","link":"Link: ","source":"Source: 兼一书虫","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'python协程',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-09-19 21:48:24'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/rightMenu.css"><link rel="stylesheet" href="/css/mouse.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/%E5%85%BC%E4%B8%80%E5%A4%B4%E5%83%8F.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">79</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">100</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-compass"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fa fa-video"></i><span> 追番</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fa fa-image"></i><span> 相册</span></a></li><li><a class="site-page child" href="/video/"><i class="fa-fw fa fa-image"></i><span> 视频</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/shuoshuo/"><i class="fa-fw fa fa-comments"></i><span> 微言</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://images5.alphacoders.com/729/729952.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">兼一书虫</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-compass"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fa fa-video"></i><span> 追番</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fa fa-image"></i><span> 相册</span></a></li><li><a class="site-page child" href="/video/"><i class="fa-fw fa fa-image"></i><span> 视频</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/shuoshuo/"><i class="fa-fw fa fa-comments"></i><span> 微言</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">python协程</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-09-10T12:46:25.000Z" title="Created 2022-09-10 20:46:25">2022-09-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-09-19T13:48:24.667Z" title="Updated 2022-09-19 21:48:24">2022-09-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/python/">python</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">12.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>51min</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title="python协程"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/article/56863.html#post-comment"><span id="twikoo-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><hr>
<h1 id="python迭代对象"><a href="#python迭代对象" class="headerlink" title="python迭代对象"></a>python迭代对象</h1><p>扫描内存中放不下的数据集时，我们要找到一种<strong>惰性</strong>获取数据项的方式，即按需一次获取一个数据项</p>
<p>这就是迭代器模式（Iterator pattern），迭代是数据处理的基石</p>
<blockquote>
<p>Python 2.2（2001 年）加入了 <code>yield</code> 关键字。这个关键字用于构建生成器（generator），其作用与迭代器一样。</p>
</blockquote>
<ul>
<li>所有生成器都是迭代器，因为生成器完全实现了迭代器接口。</li>
<li>迭代器用于从集合中取出元素；而生成器用于“凭空”生成元素。</li>
<li>Python 社区中，大多数时候都把<strong>迭代器</strong>和<strong>生成器</strong>视作同一概念。</li>
</ul>
<p>内置的 <code>range()</code> 函数也返回一个类似生成器的对象，而以前则返回完整的列表</p>
<p>如果一定要让 <code>range()</code> 函数返回列表，那么必须明确指明（例如，<code>list(range(100))</code>）</p>
<blockquote>
<p><strong>序列可以迭代的原因</strong>：<code>iter</code>函数</p>
</blockquote>
<p>解释器需要迭代对象 <code>x</code> 时，会自动调用 <code>iter(x)</code></p>
<blockquote>
<p>内置的 <code>iter</code> 函数有以下作用</p>
</blockquote>
<ul>
<li>检查对象是否实现了 <code>__iter__</code> 方法，如果实现了就调用它，获取一个迭代器</li>
<li>如果没有实现 <code>__iter__</code> 方法，但是实现了 <code>__getitem__</code> 方法，Python 会创建一个迭代器，尝试按顺序（从索引 0 开始）获取元素</li>
<li>如果尝试失败，Python 抛出 <code>TypeError</code> 异常，通常会提示“C object is not iterable”（C 对象不可迭代），其中 C 是目标对象所属的类</li>
</ul>
<blockquote>
<p>任何 Python 序列都可迭代的原因是，它们都实现了 <code>__getitem__</code> 方法</p>
</blockquote>
<ul>
<li>鸭子类型（duck typing）的极端形式<ul>
<li>不仅要实现特殊的 <code>__iter__</code> 方法，还要实现 <code>__getitem__</code> 方法</li>
<li>而且 <code>__getitem__</code> 方法的参数是从 <code>0</code> 开始的整数（<code>int</code>），这样才认为对象是可迭代的</li>
</ul>
</li>
<li>白鹅类型（goose-typing）理论中，可迭代对象的定义简单一些，不过没那么灵活<ul>
<li>如果实现了 <code>__iter__</code> 方法，那么就认为对象是可迭代的</li>
</ul>
</li>
</ul>
<p>检查对象 <code>x</code> 能否迭代，最准确的方法是：调用 <code>iter(x)</code>函数，如果不可迭代，再处理 <code>TypeError</code> 异常</p>
<p>这比使用 <code>isinstance(x, abc.Iterable)</code> 更准确<br>因为 <code>iter(x)</code> 函数会考虑到遗留的 <code>__getitem__</code> 方法，而 <code>abc.Iterable</code> 类则不考虑</p>
<h2 id="可迭代的对象"><a href="#可迭代的对象" class="headerlink" title="可迭代的对象"></a><strong>可迭代的对象</strong></h2><blockquote>
<p>使用 <code>iter</code> 内置函数可以获取迭代器的对象</p>
</blockquote>
<p>如果对象实现了能返回<strong>迭代器</strong>的 <code>__iter__</code> 方法，那么对象就是可迭代的。序列都可以迭代；实现了 <code>__getitem__</code>方法，而且其参数是从零开始的索引，这种对象也可以迭代。</p>
<blockquote>
<p>遍历方式</p>
</blockquote>
<p>下面是一个简单的 <code>for</code> 循环，迭代一个字符串。这里，字符串 <code>&#39;ABC&#39;</code> 是可迭代的对象。背后是有迭代器的，只不过我们看不到：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = <span class="string">&#x27;ABC&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> char <span class="keyword">in</span> s:</span><br><span class="line"><span class="meta">... </span>    <span class="built_in">print</span>(char)</span><br><span class="line">...</span><br><span class="line">A</span><br><span class="line">B</span><br><span class="line">C</span><br></pre></td></tr></table></figure>

<p>如果没有 <code>for</code> 语句，不得不使用 <code>while</code> 循环模拟，要像下面这样写：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = <span class="string">&#x27;ABC&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>it = <span class="built_in">iter</span>(s)  <span class="comment"># ➊</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">try</span>:</span><br><span class="line"><span class="meta">... </span>        <span class="built_in">print</span>(<span class="built_in">next</span>(it))  <span class="comment"># ➋</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">except</span> StopIteration:  <span class="comment"># ➌</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">del</span> it  <span class="comment"># ➍</span></span><br><span class="line"><span class="meta">... </span>        <span class="keyword">break</span>  <span class="comment"># ➎</span></span><br><span class="line">...</span><br><span class="line">A</span><br><span class="line">B</span><br><span class="line">C</span><br><span class="line"></span><br><span class="line">❶ 使用可迭代的对象构建迭代器 it。</span><br><span class="line">❷ 不断在迭代器上调用 <span class="built_in">next</span> 函数，获取下一个字符。</span><br><span class="line">❸ 如果没有字符了，迭代器会抛出 StopIteration 异常。</span><br><span class="line">❹ 释放对 it 的引用，即废弃迭代器对象。</span><br><span class="line">❺ 退出循环。</span><br></pre></td></tr></table></figure>

<p><code>StopIteration</code> 异常表明迭代器到头了</p>
<p>Python 语言内部会处理 <code>for</code> 循环和其他迭代上下文（如列表推导、元组拆包，等等）中的 <code>StopIteration</code> 异常</p>
<p><font color=07B8AD size=4>明确可迭代的对象和迭代器之间的关系：Python 从可迭代的对象中获取迭代器</font></p>
<h2 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h2><blockquote>
<p>标准的迭代器接口有两个方法</p>
</blockquote>
<ul>
<li><p><strong>__next__</strong>: 返回下一个可用的元素，如果没有元素了，抛出 <code>StopIteration</code> 异常。</p>
</li>
<li><p><strong>__iter__</strong>: 返回 <code>self</code>，以便在应该使用可迭代对象的地方使用迭代器，例如在 <code>for</code> 循环中。</p>
</li>
</ul>
<p><img src="../../../../img/3.python%E5%8D%8F%E7%A8%8B/image-20200607014519334.png" alt="img"><br><code>Iterator</code> 抽象基类实现 <code>__iter__</code> 方法的方式是返回实例本身（<code>return self</code>）</p>
<p>如果想再次迭代，要重新构建迭代器，在需要可迭代对象的地方可以使用迭代器</p>
<blockquote>
<p>检查迭代器遗留对象</p>
</blockquote>
<p>因为迭代器只需 <code>__next__</code> 和 <code>__iter__</code> 两个方法，所以除了调用 <code>next()</code> 方法，以及捕获 <code>StopIteration</code> 异常之外，没有办法检查是否还有遗留的元素</p>
<p>Python 中的迭代器还实现了 <code>__iter__</code> 方法，因此迭代器也<strong>可以迭代</strong></p>
<blockquote>
<p>使用迭代器模式实现 <code>Sentence</code> 类</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> reprlib</span><br><span class="line">RE_WORD = re.<span class="built_in">compile</span>(<span class="string">&#x27;\w+&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sentence</span>:</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, text</span>):</span><br><span class="line">   self.text = text</span><br><span class="line">   self.words = RE_WORD.findall(text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&#x27;Sentence(%s)&#x27;</span> % reprlib.<span class="built_in">repr</span>(self.text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):  ➊</span><br><span class="line">   <span class="keyword">return</span> SentenceIterator(self.words)  ➋</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SentenceIterator</span>:</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, words</span>):</span><br><span class="line">   self.words = words  ➌</span><br><span class="line">   self.index = <span class="number">0</span>  ➍</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__next__</span>(<span class="params">self</span>):</span><br><span class="line">   <span class="keyword">try</span>:</span><br><span class="line">       word = self.words[self.index]  ➎</span><br><span class="line">   <span class="keyword">except</span> IndexError:</span><br><span class="line">       <span class="keyword">raise</span> StopIteration()  ➏</span><br><span class="line">   self.index += <span class="number">1</span>  ➐</span><br><span class="line">   <span class="keyword">return</span> word  ➑</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):  ➒</span><br><span class="line">   <span class="keyword">return</span> self</span><br></pre></td></tr></table></figure>

<p>对这个示例来说，其实没必要在 <code>SentenceIterator</code> 类中实现 <code>__iter__</code>方法，不过这么做是对的，因为迭代器应该实现 <code>__next__</code> 和 <code>__iter__</code> 两个方法，而且这么做能让迭代器通过 <code>issubclass(SentenceIterator, abc.Iterator)</code> 测试</p>
<ul>
<li><p>可迭代的对象有个 <code>__iter__</code> 方法，每次都实例化一个新的迭代器；</p>
</li>
<li><p>而迭代器要实现 <code>__next__</code> 方法，返回单个元素，此外还要实现 <code>__iter__</code> 方法，返回迭代器本身。</p>
</li>
</ul>
<p>为了“支持多种遍历”，必须能从同一个可迭代的实例中获取多个独立的迭代器，而且各个迭代器要能维护自身的内部状态，因此这一模式正确的实现方式是，每次调用 <code>iter(my_iterable)</code> 都新建一个独立的迭代器。这就是为什么这个示例需要定义 <code>SentenceIterator</code> 类</p>
<h2 id="规约函数"><a href="#规约函数" class="headerlink" title="规约函数"></a>规约函数</h2><blockquote>
<p>接受一个可迭代的对象，然后返回单个结果。这些函数叫<font color="#DA70D6">归约函数</font></p>
</blockquote>
<p>对 <code>all</code> 和 <code>any</code> 函数来说，有一项重要的优化措施是 <code>reduce</code> 函数做不到的<br>这两个函数会短路（即一旦确定了结果就立即停止使用迭代器）</p>
<table>
<thead>
<tr>
<th align="center">模块</th>
<th align="center">函数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">内置</td>
<td align="center">all(it)</td>
<td align="left"><code>it</code> 中的所有元素都为真值时返回 <code>True</code>，否则返回 False<br /><code>all([])</code> 返回 True</td>
</tr>
<tr>
<td align="center">内置</td>
<td align="center">any(it)</td>
<td align="left">只要 <code>it</code> 中有元素为真值就返回 <code>True</code>，否则返回 <code>False</code><br /><code>any([])</code> 返回 False</td>
</tr>
<tr>
<td align="center">内置</td>
<td align="center">max(it, [key&#x3D;,] [default&#x3D;])</td>
<td align="left">返回 <code>it</code> 中值最大的元素；*<code>key</code> 是排序函数，与 <code>sorted</code> 函数中的一样<br />如果可迭代的对象为空，返回 <code>default</code></td>
</tr>
<tr>
<td align="center">内置</td>
<td align="center">min(it, [key&#x3D;,] [default&#x3D;])</td>
<td align="left">返回 <code>it</code> 中值最小的元素；#<code>key</code> 是排序函数，与 <code>sorted</code> 函数中的一样<br />如果可迭代的对象为空，返回 <code>default</code></td>
</tr>
<tr>
<td align="center">functools</td>
<td align="center">reduce(func, it, [initial])</td>
<td align="left">把前两个元素传给 <code>func</code>，然后把计算结果和第三个元素传给 <code>func</code>，以此类推，返回最后的结果<br />如果提供了 <code>initial</code>，把它当作第一个元素传入</td>
</tr>
<tr>
<td align="center">内置</td>
<td align="center">sum(it, start&#x3D;0)</td>
<td align="left"><code>it</code> 中所有元素的总和，如果提供可选的 <code>start</code>，会把它加上（计算浮点数的加法时，可以使用 <code>math.fsum</code> 函数提高精度）</td>
</tr>
</tbody></table>
<p>在 Python 中迭代对象 <code>x</code> 时会调用 <code>iter(x)</code>。</p>
<blockquote>
<p><code>iter</code> 函数还有一个鲜为人知的用法：传入两个参数，使用常规的函数或任何可调用的对象创建迭代器</p>
</blockquote>
<p>这样使用时，第一个参数必须是可调用的对象，用于不断调用（没有参数），产出各个值；第二个值是哨符，这是个标记值，当可调用的对象返回这个值时，触发迭代器抛出 <code>StopIteration</code> 异常，而不产出哨符</p>
<h2 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h2><blockquote>
<p>只要 Python 函数的定义体中有 <code>yield</code> 关键字，该函数就是生成器函数</p>
</blockquote>
<p>生成器函数会创建一个生成器对象，包装生成器函数的定义体</p>
<p>把生成器传给 <code>next(...)</code> 函数时，生成器函数会向前，执行函数定义体中的下一个 <code>yield</code> 语句</p>
<p>返回产出的值，并在函数定义体的当前位置暂停</p>
<p>最终，函数的定义体返回时，外层的生成器对象会抛出 <code>StopIteration</code> 异常——这一点与迭代器协议一致</p>
<p>如果一个类只是为了构建生成器而去实现 <code>__iter__</code> 方法，那还不如使用生成器函数</p>
<blockquote>
<p>惰性是好的特质，至少在编程语言和 API 中是如此，惰性实现是指尽可能延后生成值</p>
<p>这样做能节省内存，而且或许还可以避免做无用的处理</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> reprlib</span><br><span class="line">RE_WORD = re.<span class="built_in">compile</span>(<span class="string">&#x27;\w+&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sentence</span>:</span><br><span class="line"> <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, text</span>):</span><br><span class="line">     self.text = text  ➊</span><br><span class="line"></span><br><span class="line"> <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">     <span class="keyword">return</span> <span class="string">&#x27;Sentence(%s)&#x27;</span> % reprlib.<span class="built_in">repr</span>(self.text)</span><br><span class="line"></span><br><span class="line"> <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">     <span class="keyword">for</span> <span class="keyword">match</span> <span class="keyword">in</span> RE_WORD.finditer(self.text):  ➋</span><br><span class="line">         <span class="keyword">yield</span> <span class="keyword">match</span>.group()  ➌</span><br><span class="line">❶ 不再需要 words 列表。</span><br><span class="line">❷ finditer 函数构建一个迭代器，包含 self.text 中匹配 RE_WORD 的单词，产出 MatchObject 实例。</span><br><span class="line">❸ <span class="keyword">match</span>.group() 方法从 MatchObject 实例中提取匹配正则表达式的具体文本</span><br></pre></td></tr></table></figure>

<p>生成器表达式可以理解为列表推导的惰性版本：不会迫切地构建列表，而是返回一个生成器，按需惰性生成元素</p>
<p>也就是说，如果列表推导是制造列表的工厂，那么生成器表达式就是制造生成器的工厂</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> reprlib</span><br><span class="line"></span><br><span class="line">RE_WORD = re.<span class="built_in">compile</span>(<span class="string">&#x27;\w+&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sentence</span>:</span><br><span class="line"> <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, text</span>):</span><br><span class="line">   self.text = text</span><br><span class="line"></span><br><span class="line"> <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&#x27;Sentence(%s)&#x27;</span> % reprlib.<span class="built_in">repr</span>(self.text)</span><br><span class="line"></span><br><span class="line"> <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">   <span class="keyword">return</span> (<span class="keyword">match</span>.group() <span class="keyword">for</span> <span class="keyword">match</span> <span class="keyword">in</span> RE_WORD.finditer(self.text))</span><br></pre></td></tr></table></figure>

<p>最终的效果一样：调用 <code>__iter__</code> 方法会得到一个生成器对象</p>
<blockquote>
<p>生成器表达式是语法糖：完全可以替换成生成器函数，不过有时使用生成器表达式更便利</p>
</blockquote>
<ul>
<li>生成器表达式是创建生成器的简洁句法，这样无需先定义函数再调用。</li>
<li>生成器函数灵活得多，可以使用多个语句实现复杂的逻辑，也可以作为<font color="#7CFC00">协程</font>使用</li>
<li>遇到简单的情况时，可以使用生成器表达式</li>
<li>如果生成器表达式要分成多行写，我倾向于定义生成器函数，以便提高可读性</li>
<li>如果函数或构造方法只有一个参数，传入生成器表达式时不用写一对调用函数的括号<br>再写一对括号围住生成器表达式，只写一对括号就行了</li>
</ul>
<blockquote>
<p>迭代器有两个特点</p>
</blockquote>
<ul>
<li>接口<ul>
<li>Python 的迭代器协议定义了两个方法：<code>__next__</code> 和 <code>__iter__</code></li>
<li>生成器对象实现了这两个方法，因此从这方面来看，所有生成器都是迭代器</li>
</ul>
</li>
<li>实现方式<ul>
<li>生成器这种 Python 语言结构可以使用两种方式编写：含有 <code>yield</code> 关键字的函数，或者生成器表达式</li>
<li>调用生成器函数或者执行生成器表达式得到的生成器对象属于语言内部的 <code>GeneratorType</code> 类型</li>
</ul>
</li>
</ul>
<blockquote>
<p>迭代器可以节约大量的空间</p>
</blockquote>
<p>当需要生成的数列数量非常大时，由于代码中将数字存储在 list 中，会导致巨大内存占用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Fab</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, <span class="built_in">max</span></span>):</span><br><span class="line">       self.<span class="built_in">max</span> = <span class="built_in">max</span></span><br><span class="line">       self.n, self.a, self.b = <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span></span><br><span class="line"> </span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">       <span class="keyword">return</span> self</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">next</span>(<span class="params">self</span>):</span><br><span class="line">       <span class="keyword">if</span> self.n &lt; self.<span class="built_in">max</span>:</span><br><span class="line">           r = self.b</span><br><span class="line">           self.a, self.b = self.b, self.a + self.b</span><br><span class="line">           self.n = self.n + <span class="number">1</span></span><br><span class="line">           <span class="keyword">return</span> r</span><br><span class="line">       <span class="keyword">raise</span> StopIteration()</span><br><span class="line">Fab(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">Out[<span class="number">56</span>]: [<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">8</span>]</span><br></pre></td></tr></table></figure>

<p>上述代码通过类的形式将函数封装为一个可迭代对象</p>
<p>通过next方法在循环的时候每次去取一个数，只有在需要使用的时候才会生成，内存占用很小</p>
<p>但是，上述代码较为繁琐，在Python中，有一种语法糖能简化，那就是 yield </p>
<p>如果这个元素可以通过某种方式推算出来切可以进行循环操作，就避免了大的内存占用</p>
<p>只需要函数在循环时计算得下一个数字并返回，这样就不必创建完整的 list ，从而节省大量空间</p>
<p>在Python中，这种一边循环一边计算的机制，称为生成器： generator 。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yield 语法糖</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fab</span>(<span class="params"><span class="built_in">max</span></span>):</span><br><span class="line">    n, a, b = <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> n &lt; <span class="built_in">max</span>:</span><br><span class="line">        <span class="keyword">yield</span> b</span><br><span class="line">        <span class="comment"># print b</span></span><br><span class="line">        a, b = b, a + b</span><br><span class="line">        n = n + <span class="number">1</span></span><br><span class="line">fab(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">Out[<span class="number">56</span>]: [<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">8</span>]</span><br></pre></td></tr></table></figure>

<p>调用和 Fab 版的完全一致，也可以使用 next 方法等。简单的说， yield 的作用就是把一个函数变为一个 generator ，带有 yield 的函数不再是一个普通函数， Python 解释器会将器视为 generator </p>
<p>在 for 循环执行时，每次循环都会执行 fab 函数内部的代码，执行到 yield 时</p>
<p>函数就返回一个迭代值，下次迭代时，就从 yield 的下一句继续执行，调用next也是同理</p>
<p>当函数执行结束时，会抛出 StopIteration 异常，表示迭代完成</p>
<h2 id="itertools模块"><a href="#itertools模块" class="headerlink" title="itertools模块"></a>itertools模块</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3.7/library/itertools.html">itertools — 为高效循环而创建迭代器的函数</a></p>
<p><a target="_blank" rel="noopener" href="http://wklken.me/posts/2013/08/20/python-extra-itertools.html">Python-进阶-itertools模块小结</a></p>
<p><a target="_blank" rel="noopener" href="https://wiki.jikexueyuan.com/project/explore-python/Standard-Modules/itertools.html">itertools</a></p>
</blockquote>
<p>迭代器的特点是：<strong>惰性求值</strong>（Lazy evaluation），即只有当迭代至某个值时，它才会被计算，这个特点使得迭代器特别适合于遍历大文件或无限集合等，因为我们不用一次性将它们存储在内存中</p>
<p>Python 内置的 itertools 模块包含了一系列用来产生不同类型迭代器的函数或类，这些函数的返回都是一个迭代器，我们可以通过 for 循环来遍历取值，也可以使用 <code>next()</code> 来取值</p>
<blockquote>
<p>itertools 模块提供的迭代器函数有以下几种类型：</p>
</blockquote>
<ul>
<li><strong>无限迭代器</strong>：生成一个无限序列，比如自然数序列 <code>1, 2, 3, 4, ...</code></li>
<li><strong>有限迭代器</strong>：接收一个或多个序列（sequence）作为参数，进行组合、分组和过滤等</li>
<li><strong>组合生成器</strong>：序列的排列、组合，求序列的笛卡儿积等</li>
</ul>
<h3 id="无限迭代器"><a href="#无限迭代器" class="headerlink" title="无限迭代器"></a>无限迭代器</h3><blockquote>
<p>itertools 模块提供了三个函数（事实上，它们是类）用于生成一个无限序列迭代器</p>
</blockquote>
<ul>
<li><p>count(firstval&#x3D;0, step&#x3D;1)</p>
<p>创建一个从 firstval (默认值为 0) 开始，以 step (默认值为 1) 为步长的的无限整数迭代器</p>
</li>
<li><p>cycle(iterable)</p>
<p>对 iterable 中的元素反复执行循环，返回迭代器</p>
</li>
<li><p>repeat(object [,times]</p>
<p>反复生成 object，如果给定 times，则重复次数为 times，否则为无限</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">Iterator</th>
<th align="center">Arguments</th>
<th align="center">Results</th>
<th align="center">Example</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><a target="_blank" rel="noopener" href="https://docs.python.org/2.7/library/itertools.html#itertools.count"><code>count()</code></a></td>
<td align="center">start, [step]</td>
<td align="center">start, start+step, start+2*step, …</td>
<td align="center"><code>count(10) --&gt; 10 11 12 13 14 ...</code></td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://docs.python.org/2.7/library/itertools.html#itertools.cycle"><code>cycle()</code></a></td>
<td align="center">p</td>
<td align="center">p0, p1, … plast, p0, p1, …</td>
<td align="center"><code>cycle(&#39;ABCD&#39;) --&gt; A B C D A B C D ...</code></td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://docs.python.org/2.7/library/itertools.html#itertools.repeat"><code>repeat()</code></a></td>
<td align="center">elem [,n]</td>
<td align="center">elem, elem, elem, … endlessly or up to n times</td>
<td align="center"><code>repeat(10, 3) --&gt; 10 10 10</code></td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line">nums = itertools.count(start=<span class="number">2</span>,step=<span class="number">3</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> nums:</span><br><span class="line">    <span class="keyword">if</span> i&gt;<span class="number">15</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">Out[<span class="number">17</span>]: </span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">11</span></span><br><span class="line"></span><br><span class="line">[i <span class="keyword">for</span> i <span class="keyword">in</span> itertools.repeat([<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>],<span class="number">3</span>)]</span><br><span class="line">Out[<span class="number">18</span>]: [[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>], [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>], [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>]]</span><br></pre></td></tr></table></figure>

<h3 id="有限迭代器"><a href="#有限迭代器" class="headerlink" title="有限迭代器"></a>有限迭代器</h3><blockquote>
<p>itertools 模块提供了多个函数（类），接收一个或多个迭代对象作为参数，对它们进行组合、分组和过滤等</p>
</blockquote>
<ul>
<li>chain()</li>
<li>compress()</li>
<li>dropwhile()</li>
<li>groupby()</li>
<li>ifilter()</li>
<li>ifilterfalse()</li>
<li>islice()</li>
<li>imap()</li>
<li>starmap()</li>
<li>tee()</li>
<li>takewhile()</li>
<li>izip()</li>
<li>izip_longest()</li>
</ul>
<table>
<thead>
<tr>
<th align="center">Iterator</th>
<th align="center">Arguments</th>
<th align="center">Results</th>
<th align="center">Example</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><a target="_blank" rel="noopener" href="https://docs.python.org/2.7/library/itertools.html#itertools.chain"><code>chain()</code></a></td>
<td align="center">p, q, …</td>
<td align="center">p0, p1, … plast, q0, q1, …</td>
<td align="center"><code>chain(&#39;ABC&#39;, &#39;DEF&#39;) --&gt; A B C D E F</code></td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://docs.python.org/2.7/library/itertools.html#itertools.compress"><code>compress()</code></a></td>
<td align="center">data, selectors</td>
<td align="center">(d[0] if s[0]), (d[1] if s[1]), …</td>
<td align="center"><code>compress(&#39;ABCDEF&#39;, [1,0,1,0,1,1]) --&gt; A C E F</code></td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://docs.python.org/2.7/library/itertools.html#itertools.dropwhile"><code>dropwhile()</code></a></td>
<td align="center">pred, seq</td>
<td align="center">seq[n], seq[n+1], starting when pred fails</td>
<td align="center"><code>dropwhile(lambda x: x&lt;5, [1,4,6,4,1]) --&gt; 6 4 1</code></td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://docs.python.org/2.7/library/itertools.html#itertools.groupby"><code>groupby()</code></a></td>
<td align="center">iterable[, keyfunc]</td>
<td align="center">sub-iterators grouped by value of keyfunc(v)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://docs.python.org/2.7/library/itertools.html#itertools.ifilter"><code>ifilter()</code></a></td>
<td align="center">pred, seq</td>
<td align="center">elements of seq where pred(elem) is true</td>
<td align="center"><code>ifilter(lambda x: x%2, range(10)) --&gt; 1 3 5 7 9</code></td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://docs.python.org/2.7/library/itertools.html#itertools.ifilterfalse"><code>ifilterfalse()</code></a></td>
<td align="center">pred, seq</td>
<td align="center">elements of seq where pred(elem) is false</td>
<td align="center"><code>ifilterfalse(lambda x: x%2, range(10)) --&gt; 0 2 4 6 8</code></td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://docs.python.org/2.7/library/itertools.html#itertools.islice"><code>islice()</code></a></td>
<td align="center">seq, [start,] stop [, step]</td>
<td align="center">elements from seq[start:stop:step]</td>
<td align="center"><code>islice(&#39;ABCDEFG&#39;, 2, None) --&gt; C D E F G</code></td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://docs.python.org/2.7/library/itertools.html#itertools.starmap"><code>starmap()</code></a></td>
<td align="center">func, seq</td>
<td align="center">func(*seq[0]), func(*seq[1]), …</td>
<td align="center"><code>starmap(pow, [(2,5), (3,2), (10,3)]) --&gt; 32 9 1000</code></td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://docs.python.org/2.7/library/itertools.html#itertools.tee"><code>tee()</code></a></td>
<td align="center">it, n</td>
<td align="center">it1, it2, … itn splits one iterator into n</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://docs.python.org/2.7/library/itertools.html#itertools.takewhile"><code>takewhile()</code></a></td>
<td align="center">pred, seq</td>
<td align="center">seq[0], seq[1], until pred fails</td>
<td align="center"><code>takewhile(lambda x: x&lt;5, [1,4,6,4,1]) --&gt; 1 4</code></td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://docs.python.org/2.7/library/itertools.html#itertools.izip_longest"><code>zip_longest()</code></a></td>
<td align="center">p, q, …</td>
<td align="center">(p[0], q[0]), (p[1], q[1]), …</td>
<td align="center"><code>zip_longest(&#39;ABCD&#39;, &#39;xy&#39;, fillvalue=&#39;-&#39;) --&gt; Ax By C- D-</code></td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">[item <span class="keyword">for</span> item <span class="keyword">in</span> itertools.chain([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>])]</span><br><span class="line">Out[<span class="number">19</span>]: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]</span><br><span class="line"><span class="comment"># 接收一个可迭代对象作为参数，返回一个迭代器</span></span><br><span class="line">string = itertools.chain.from_iterable(<span class="string">&#x27;ABCD&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># compress 可用于对数据进行筛选，当selectors的某个元素为true时，则保留data对应位置的元素，否则去除：</span></span><br><span class="line"><span class="comment"># compress(data, selectors)</span></span><br><span class="line"><span class="built_in">list</span>(compress(<span class="string">&#x27;ABCDEF&#x27;</span>, [<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>]))</span><br><span class="line">Out[<span class="number">23</span>]:[<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;F&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># dropwhile(predicate, iterable)</span></span><br><span class="line"><span class="comment"># 其中，predicate 是函数，iterable 是可迭代对象。对于 iterable 中的元素，如果 predicate(item) 为 true，则丢弃该元素，否则返回该项及所有后续项。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(dropwhile(<span class="keyword">lambda</span> x: x &lt; <span class="number">5</span>, [<span class="number">1</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">1</span>]))</span><br><span class="line">[<span class="number">6</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(dropwhile(<span class="keyword">lambda</span> x: x &gt; <span class="number">3</span>, [<span class="number">2</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">4</span>]))</span><br><span class="line">[<span class="number">2</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">4</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># groupby(iterable[, keyfunc])</span></span><br><span class="line"><span class="comment"># 相邻相同元素分组</span></span><br><span class="line"><span class="comment"># 其中，iterable 是一个可迭代对象，keyfunc 是分组函数，用于对 iterable 的连续项进行分组，如果不指定，则默认对 iterable 中的连续相同项进行分组，返回一个 (key, sub-iterator) 的迭代器。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> key, value_iter <span class="keyword">in</span> groupby(<span class="string">&#x27;aaabbbaaccd&#x27;</span>):</span><br><span class="line"><span class="meta">... </span>    <span class="built_in">print</span> key, <span class="string">&#x27;:&#x27;</span>, <span class="built_in">list</span>(value_iter)</span><br><span class="line">...</span><br><span class="line">a : [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>]</span><br><span class="line">b : [<span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;b&#x27;</span>]</span><br><span class="line">a : [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>]</span><br><span class="line">c : [<span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]</span><br><span class="line">d : [<span class="string">&#x27;d&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ifilter(function or None, sequence)</span></span><br><span class="line"><span class="comment"># 将 iterable 中 function(item) 为 True 的元素组成一个迭代器返回，如果 function 是 None，则返回 iterable 中所有计算为 True 的项。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(ifilter(<span class="keyword">lambda</span> x: x &lt; <span class="number">6</span>, <span class="built_in">range</span>(<span class="number">10</span>)))</span><br><span class="line">[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(ifilter(<span class="literal">None</span>, [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">4</span>]))</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ifilterfalse 的使用形式和 ifilter 类似，它将 iterable 中 function(item) 为 False 的元素组成一个迭代器返回，如果 function 是 None，则返回 iterable 中所有计算为 False 的项。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(ifilterfalse(<span class="keyword">lambda</span> x: x &lt; <span class="number">6</span>, <span class="built_in">range</span>(<span class="number">10</span>)))</span><br><span class="line">[<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(ifilter(<span class="literal">None</span>, [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">4</span>]))</span><br><span class="line">[<span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># islice(iterable, [start,] stop [, step]) </span></span><br><span class="line"><span class="comment"># 其中，iterable 是可迭代对象，start 是开始索引，stop 是结束索引，step 是步长，start 和 step 可选。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(islice([<span class="number">10</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">9</span>], <span class="number">5</span>))</span><br><span class="line">[<span class="number">10</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">1</span>]</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(islice(count(), <span class="number">6</span>))</span><br><span class="line">[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(islice(count(), <span class="number">3</span>, <span class="number">10</span>))</span><br><span class="line">[<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(islice(count(), <span class="number">3</span>, <span class="number">10</span> ,<span class="number">2</span>))</span><br><span class="line">[<span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># tee 用于从 iterable 创建 n 个独立的迭代器，以元组的形式返回，n 的默认值是 2。</span></span><br><span class="line">iter1, iter2 = tee(<span class="string">&#x27;abcde&#x27;</span>)</span><br><span class="line"><span class="comment"># n 默认为 2，创建两个独立的迭代器</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># takewhile(predicate, iterable)</span></span><br><span class="line"><span class="comment"># 其中，predicate 是函数，iterable 是可迭代对象。对于 iterable 中的元素，如果 predicate(item) 为 true，则保留该元素，只要 predicate(item) 为 false，则立即停止迭代。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(takewhile(<span class="keyword">lambda</span> x: x &lt; <span class="number">5</span>, [<span class="number">1</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">1</span>]))</span><br><span class="line">[<span class="number">1</span>, <span class="number">3</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(takewhile(<span class="keyword">lambda</span> x: x &gt; <span class="number">3</span>, [<span class="number">2</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">4</span>]))</span><br><span class="line">[]</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> zip_longest</span><br><span class="line">[item <span class="keyword">for</span> item <span class="keyword">in</span> zip_longest(<span class="string">&#x27;ABCD&#x27;</span>, <span class="string">&#x27;xy&#x27;</span>)]</span><br><span class="line">Out[<span class="number">41</span>]: [(<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;x&#x27;</span>), (<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;y&#x27;</span>), (<span class="string">&#x27;C&#x27;</span>, <span class="literal">None</span>), (<span class="string">&#x27;D&#x27;</span>, <span class="literal">None</span>)]</span><br><span class="line">[item <span class="keyword">for</span> item <span class="keyword">in</span> zip_longest(<span class="string">&#x27;ABCD&#x27;</span>, <span class="string">&#x27;xy&#x27;</span>,fillvalue=<span class="string">&#x27;-&#x27;</span>)]</span><br><span class="line">Out[<span class="number">42</span>]: [(<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;x&#x27;</span>), (<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;y&#x27;</span>), (<span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;-&#x27;</span>), (<span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;-&#x27;</span>)]</span><br></pre></td></tr></table></figure>

<p><font color=DarkOrange size=4>itertools.groupby用法</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分组统计，并获取每组的具体元素</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> groupby</span><br><span class="line">sentence = <span class="string">&#x27;我是 哈哈  一直在  我 三连击 陈飒飒  阿豆腐干   阿苏打水丢阿萨德&#x27;</span></span><br><span class="line"></span><br><span class="line">res= itertools.groupby(<span class="built_in">sorted</span>(re.sub(<span class="string">&#x27; +&#x27;</span>,<span class="string">&#x27; &#x27;</span>,sentence).split(<span class="string">&#x27; &#x27;</span>),key=<span class="built_in">len</span>,reverse=<span class="literal">True</span>),<span class="built_in">len</span>)</span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> res:</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;%s-&gt;%s&#x27;</span>%(k,<span class="built_in">list</span>(v)))</span><br><span class="line"></span><br><span class="line"><span class="number">8</span>-&gt;[<span class="string">&#x27;阿苏打水丢阿萨德&#x27;</span>]</span><br><span class="line"><span class="number">4</span>-&gt;[<span class="string">&#x27;阿豆腐干&#x27;</span>]</span><br><span class="line"><span class="number">3</span>-&gt;[<span class="string">&#x27;一直在&#x27;</span>, <span class="string">&#x27;三连击&#x27;</span>, <span class="string">&#x27;陈飒飒&#x27;</span>]</span><br><span class="line"><span class="number">2</span>-&gt;[<span class="string">&#x27;我是&#x27;</span>, <span class="string">&#x27;哈哈&#x27;</span>]</span><br><span class="line"><span class="number">1</span>-&gt;[<span class="string">&#x27;我&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p><font color=DarkOrange size=4>itertools.tee用法</font></p>
<p><code>itertools.tee</code>分裂出来的多个生成器不是线程安全的，不能在多线程里面运行，否则会导致报错。这里给出一个报错的例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generator</span>():</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>):</span><br><span class="line">  <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line">g = generator()</span><br><span class="line">g_1, g_2 = itertools.tee(g, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> [g_1, g_2]:</span><br><span class="line">threading.Thread(target=<span class="built_in">sum</span>, args=(x, )).start()</span><br></pre></td></tr></table></figure>

<p>多线程安全版本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadingTee</span>:</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, tee_obj, lock</span>):</span><br><span class="line">  self.tee_obj = tee_obj</span><br><span class="line">  self.lock = lock</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">  <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__next__</span>(<span class="params">self</span>):</span><br><span class="line">  <span class="keyword">with</span> self.lock:</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">next</span>(self.tee_obj)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__copy__</span>(<span class="params">self</span>):</span><br><span class="line">  <span class="keyword">return</span> KingnameTee(self.tee_obj.__copy__(), self.lock)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">threading_tee</span>(<span class="params">iterable, n=<span class="number">2</span></span>):</span><br><span class="line"><span class="string">&quot;&quot;&quot;tuple of n independent thread-safe iterators&quot;&quot;&quot;</span></span><br><span class="line">lock = Lock()</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">tuple</span>(ThreadingTee(tee_obj, lock) <span class="keyword">for</span> tee_obj <span class="keyword">in</span> itertools.tee(iterable, n))</span><br></pre></td></tr></table></figure>



<h3 id="组合生成器"><a href="#组合生成器" class="headerlink" title="组合生成器"></a>组合生成器</h3><blockquote>
<p>itertools 模块还提供了多个组合生成器函数，用于求序列的排列、组合等</p>
</blockquote>
<ul>
<li>product</li>
<li>permutations</li>
<li>combinations</li>
<li>combinations_with_replacement</li>
</ul>
<table>
<thead>
<tr>
<th align="center">Iterator</th>
<th align="center">Arguments</th>
<th align="center">Results</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><a target="_blank" rel="noopener" href="https://docs.python.org/2.7/library/itertools.html#itertools.product"><code>product()</code></a></td>
<td align="center">p, q, … [repeat&#x3D;1]</td>
<td align="center">cartesian product, equivalent to a nested for-loop</td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://docs.python.org/2.7/library/itertools.html#itertools.permutations"><code>permutations()</code></a></td>
<td align="center">p[, r]</td>
<td align="center">r-length tuples, all possible orderings, no repeated elements</td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://docs.python.org/2.7/library/itertools.html#itertools.combinations"><code>combinations()</code></a></td>
<td align="center">p, r</td>
<td align="center">r-length tuples, in sorted order, no repeated elements</td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://docs.python.org/2.7/library/itertools.html#itertools.combinations_with_replacement"><code>combinations_with_replacement()</code></a></td>
<td align="center">p, r</td>
<td align="center">r-length tuples, in sorted order, with repeated elements</td>
</tr>
<tr>
<td align="center"><code>product(&#39;ABCD&#39;, repeat=2)</code></td>
<td align="center"></td>
<td align="center"><code>AA AB AC AD BA BB BC BD CA CB CC CD DA DB DC DD</code></td>
</tr>
<tr>
<td align="center"><code>permutations(&#39;ABCD&#39;, 2)</code></td>
<td align="center"></td>
<td align="center"><code>AB AC AD BA BC BD CA CB CD DA DB DC</code></td>
</tr>
<tr>
<td align="center"><code>combinations(&#39;ABCD&#39;, 2)</code></td>
<td align="center"></td>
<td align="center"><code>AB AC AD BC BD CD</code></td>
</tr>
<tr>
<td align="center"><code>combinations_with_replacement(&#39;ABCD&#39;, 2)</code></td>
<td align="center"></td>
<td align="center"><code>AA AB AC AD BB BC BD CC CD DD</code></td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># product 用于求多个可迭代对象的笛卡尔积，它跟嵌套的 for 循环等价。它的一般使用形式如下：</span></span><br><span class="line"><span class="comment"># product(iter1, iter2, ... iterN, [repeat=1])</span></span><br><span class="line"><span class="comment"># 其中，repeat 是一个关键字参数，用于指定重复生成序列的次数，</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> item <span class="keyword">in</span> product(<span class="string">&#x27;ABCD&#x27;</span>, <span class="string">&#x27;xy&#x27;</span>):</span><br><span class="line"><span class="meta">... </span>    <span class="built_in">print</span>(item)</span><br><span class="line">(<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">(<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">(<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">(<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">(<span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">(<span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">(<span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">(<span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;y&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(product(<span class="string">&#x27;ABC&#x27;</span>, repeat=<span class="number">2</span>))</span><br><span class="line">[(<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;A&#x27;</span>), (<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>), (<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;C&#x27;</span>), (<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;A&#x27;</span>), (<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;B&#x27;</span>), (<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>), (<span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;A&#x27;</span>), (<span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;B&#x27;</span>), (<span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;C&#x27;</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># permutations 用于生成一个排列，它的一般使用形式如下：</span></span><br><span class="line"><span class="comment"># permutations(iterable[, r])</span></span><br><span class="line"><span class="comment"># 其中，r 指定生成排列的元素的长度，如果不指定，则默认为可迭代对象的元素长度。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(permutations(<span class="string">&#x27;ABC&#x27;</span>, <span class="number">2</span>))</span><br><span class="line">[(<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>), (<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;C&#x27;</span>), (<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;A&#x27;</span>), (<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>), (<span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;A&#x27;</span>), (<span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;B&#x27;</span>)]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(permutations(<span class="string">&#x27;ABC&#x27;</span>))</span><br><span class="line">[(<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>), (<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;B&#x27;</span>), (<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;C&#x27;</span>), (<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;A&#x27;</span>), (<span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>), (<span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;A&#x27;</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># combinations 用于求序列的组合，它的使用形式如下：</span></span><br><span class="line"><span class="comment"># combinations(iterable, r)</span></span><br><span class="line"><span class="comment"># 其中，r 指定生成组合的元素的长度。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> itertools <span class="keyword">import</span> combinations</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(combinations(<span class="string">&#x27;ABC&#x27;</span>, <span class="number">2</span>))</span><br><span class="line">[(<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>), (<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;C&#x27;</span>), (<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># combinations_with_replacement 和 combinations 类似，但它生成的组合包含自身元素。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> itertools <span class="keyword">import</span> combinations_with_replacement</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(combinations_with_replacement(<span class="string">&#x27;ABC&#x27;</span>, <span class="number">2</span>))</span><br><span class="line">[(<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;A&#x27;</span>), (<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>), (<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;C&#x27;</span>), (<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;B&#x27;</span>), (<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>), (<span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;C&#x27;</span>)]</span><br></pre></td></tr></table></figure>

<h3 id="使用现有扩展功能"><a href="#使用现有扩展功能" class="headerlink" title="使用现有扩展功能"></a>使用现有扩展功能</h3><blockquote>
<p>使用内置的itertools可以组合扩展出更多更强大功能的方法</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">take</span>(<span class="params">n, iterable</span>):</span><br><span class="line">    <span class="string">&quot;Return first n items of the iterable as a list&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">list</span>(islice(iterable, n))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tabulate</span>(<span class="params">function, start=<span class="number">0</span></span>):</span><br><span class="line">    <span class="string">&quot;Return function(0), function(1), ...&quot;</span></span><br><span class="line">    <span class="keyword">return</span> imap(function, count(start))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">consume</span>(<span class="params">iterator, n</span>):</span><br><span class="line">    <span class="string">&quot;Advance the iterator n-steps ahead. If n is none, consume entirely.&quot;</span></span><br><span class="line">    <span class="comment"># Use functions that consume iterators at C speed.</span></span><br><span class="line">    <span class="keyword">if</span> n <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># feed the entire iterator into a zero-length deque</span></span><br><span class="line">        collections.deque(iterator, maxlen=<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># advance to the empty slice starting at position n</span></span><br><span class="line">        <span class="built_in">next</span>(islice(iterator, n, n), <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">nth</span>(<span class="params">iterable, n, default=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;Returns the nth item or a default value&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">next</span>(islice(iterable, n, <span class="literal">None</span>), default)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">quantify</span>(<span class="params">iterable, pred=<span class="built_in">bool</span></span>):</span><br><span class="line">    <span class="string">&quot;Count how many times the predicate is true&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sum</span>(imap(pred, iterable))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">padnone</span>(<span class="params">iterable</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Returns the sequence elements and then returns None indefinitely.</span></span><br><span class="line"><span class="string">    Useful for emulating the behavior of the built-in map() function.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> chain(iterable, repeat(<span class="literal">None</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ncycles</span>(<span class="params">iterable, n</span>):</span><br><span class="line">    <span class="string">&quot;Returns the sequence elements n times&quot;</span></span><br><span class="line">    <span class="keyword">return</span> chain.from_iterable(repeat(<span class="built_in">tuple</span>(iterable), n))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dotproduct</span>(<span class="params">vec1, vec2</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sum</span>(imap(operator.mul, vec1, vec2))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flatten</span>(<span class="params">listOfLists</span>):</span><br><span class="line">    <span class="string">&quot;Flatten one level of nesting&quot;</span></span><br><span class="line">    <span class="keyword">return</span> chain.from_iterable(listOfLists)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">repeatfunc</span>(<span class="params">func, times=<span class="literal">None</span>, *args</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Repeat calls to func with specified arguments.</span></span><br><span class="line"><span class="string">    Example:  repeatfunc(random.random)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> times <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> starmap(func, repeat(args))</span><br><span class="line">    <span class="keyword">return</span> starmap(func, repeat(args, times))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pairwise</span>(<span class="params">iterable</span>):</span><br><span class="line">    <span class="string">&quot;s -&gt; (s0,s1), (s1,s2), (s2, s3), ...&quot;</span></span><br><span class="line">    a, b = tee(iterable)</span><br><span class="line">    <span class="built_in">next</span>(b, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">return</span> izip(a, b)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">grouper</span>(<span class="params">iterable, n, fillvalue=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;Collect data into fixed-length chunks or blocks&quot;</span></span><br><span class="line">    <span class="comment"># grouper(&#x27;ABCDEFG&#x27;, 3, &#x27;x&#x27;) --&gt; ABC DEF Gxx</span></span><br><span class="line">    args = [<span class="built_in">iter</span>(iterable)] * n</span><br><span class="line">    <span class="keyword">return</span> izip_longest(fillvalue=fillvalue, *args)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">roundrobin</span>(<span class="params">*iterables</span>):</span><br><span class="line">    <span class="string">&quot;roundrobin(&#x27;ABC&#x27;, &#x27;D&#x27;, &#x27;EF&#x27;) --&gt; A D E B F C&quot;</span></span><br><span class="line">    <span class="comment"># Recipe credited to George Sakkis</span></span><br><span class="line">    pending = <span class="built_in">len</span>(iterables)</span><br><span class="line">    nexts = cycle(<span class="built_in">iter</span>(it).<span class="built_in">next</span> <span class="keyword">for</span> it <span class="keyword">in</span> iterables)</span><br><span class="line">    <span class="keyword">while</span> pending:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">for</span> <span class="built_in">next</span> <span class="keyword">in</span> nexts:</span><br><span class="line">                <span class="keyword">yield</span> <span class="built_in">next</span>()</span><br><span class="line">        <span class="keyword">except</span> StopIteration:</span><br><span class="line">            pending -= <span class="number">1</span></span><br><span class="line">            nexts = cycle(islice(nexts, pending))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">powerset</span>(<span class="params">iterable</span>):</span><br><span class="line">    <span class="string">&quot;powerset([1,2,3]) --&gt; () (1,) (2,) (3,) (1,2) (1,3) (2,3) (1,2,3)&quot;</span></span><br><span class="line">    s = <span class="built_in">list</span>(iterable)</span><br><span class="line">    <span class="keyword">return</span> chain.from_iterable(combinations(s, r) <span class="keyword">for</span> r <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)+<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unique_everseen</span>(<span class="params">iterable, key=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;List unique elements, preserving order. Remember all elements ever seen.&quot;</span></span><br><span class="line">    <span class="comment"># unique_everseen(&#x27;AAAABBBCCDAABBB&#x27;) --&gt; A B C D</span></span><br><span class="line">    <span class="comment"># unique_everseen(&#x27;ABBCcAD&#x27;, str.lower) --&gt; A B C D</span></span><br><span class="line">    seen = <span class="built_in">set</span>()</span><br><span class="line">    seen_add = seen.add</span><br><span class="line">    <span class="keyword">if</span> key <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">for</span> element <span class="keyword">in</span> ifilterfalse(seen.__contains__, iterable):</span><br><span class="line">            seen_add(element)</span><br><span class="line">            <span class="keyword">yield</span> element</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> element <span class="keyword">in</span> iterable:</span><br><span class="line">            k = key(element)</span><br><span class="line">            <span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">in</span> seen:</span><br><span class="line">                seen_add(k)</span><br><span class="line">                <span class="keyword">yield</span> element</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unique_justseen</span>(<span class="params">iterable, key=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;List unique elements, preserving order. Remember only the element just seen.&quot;</span></span><br><span class="line">    <span class="comment"># unique_justseen(&#x27;AAAABBBCCDAABBB&#x27;) --&gt; A B C D A B</span></span><br><span class="line">    <span class="comment"># unique_justseen(&#x27;ABBCcAD&#x27;, str.lower) --&gt; A B C A D</span></span><br><span class="line">    <span class="keyword">return</span> imap(<span class="built_in">next</span>, imap(itemgetter(<span class="number">1</span>), groupby(iterable, key)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">iter_except</span>(<span class="params">func, exception, first=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; Call a function repeatedly until an exception is raised.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Converts a call-until-exception interface to an iterator interface.</span></span><br><span class="line"><span class="string">    Like __builtin__.iter(func, sentinel) but uses an exception instead</span></span><br><span class="line"><span class="string">    of a sentinel to end the loop.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Examples:</span></span><br><span class="line"><span class="string">        bsddbiter = iter_except(db.next, bsddb.error, db.first)</span></span><br><span class="line"><span class="string">        heapiter = iter_except(functools.partial(heappop, h), IndexError)</span></span><br><span class="line"><span class="string">        dictiter = iter_except(d.popitem, KeyError)</span></span><br><span class="line"><span class="string">        dequeiter = iter_except(d.popleft, IndexError)</span></span><br><span class="line"><span class="string">        queueiter = iter_except(q.get_nowait, Queue.Empty)</span></span><br><span class="line"><span class="string">        setiter = iter_except(s.pop, KeyError)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> first <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">yield</span> first()</span><br><span class="line">        <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">yield</span> func()</span><br><span class="line">    <span class="keyword">except</span> exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">random_product</span>(<span class="params">*args, **kwds</span>):</span><br><span class="line">    <span class="string">&quot;Random selection from itertools.product(*args, **kwds)&quot;</span></span><br><span class="line">    pools = <span class="built_in">map</span>(<span class="built_in">tuple</span>, args) * kwds.get(<span class="string">&#x27;repeat&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">tuple</span>(random.choice(pool) <span class="keyword">for</span> pool <span class="keyword">in</span> pools)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">random_permutation</span>(<span class="params">iterable, r=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;Random selection from itertools.permutations(iterable, r)&quot;</span></span><br><span class="line">    pool = <span class="built_in">tuple</span>(iterable)</span><br><span class="line">    r = <span class="built_in">len</span>(pool) <span class="keyword">if</span> r <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> r</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">tuple</span>(random.sample(pool, r))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">random_combination</span>(<span class="params">iterable, r</span>):</span><br><span class="line">    <span class="string">&quot;Random selection from itertools.combinations(iterable, r)&quot;</span></span><br><span class="line">    pool = <span class="built_in">tuple</span>(iterable)</span><br><span class="line">    n = <span class="built_in">len</span>(pool)</span><br><span class="line">    indices = <span class="built_in">sorted</span>(random.sample(xrange(n), r))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">tuple</span>(pool[i] <span class="keyword">for</span> i <span class="keyword">in</span> indices)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">random_combination_with_replacement</span>(<span class="params">iterable, r</span>):</span><br><span class="line">    <span class="string">&quot;Random selection from itertools.combinations_with_replacement(iterable, r)&quot;</span></span><br><span class="line">    pool = <span class="built_in">tuple</span>(iterable)</span><br><span class="line">    n = <span class="built_in">len</span>(pool)</span><br><span class="line">    indices = <span class="built_in">sorted</span>(random.randrange(n) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(r))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">tuple</span>(pool[i] <span class="keyword">for</span> i <span class="keyword">in</span> indices)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tee_lookahead</span>(<span class="params">t, i</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Inspect the i-th upcomping value from a tee object</span></span><br><span class="line"><span class="string">    while leaving the tee object at its current position.</span></span><br><span class="line"><span class="string">    Raise an IndexError if the underlying iterator doesn&#x27;t</span></span><br><span class="line"><span class="string">    have enough values.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> islice(t.__copy__(), i, <span class="literal">None</span>):</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    <span class="keyword">raise</span> IndexError(i)</span><br></pre></td></tr></table></figure>

<h3 id="自定义扩展"><a href="#自定义扩展" class="headerlink" title="自定义扩展"></a>自定义扩展</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将序列按大小切分,更好的性能</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain, islice</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chunks</span>(<span class="params">iterable, size, <span class="built_in">format</span>=<span class="built_in">iter</span></span>):</span><br><span class="line">    it = <span class="built_in">iter</span>(iterable)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> <span class="built_in">format</span>(chain((it.<span class="built_in">next</span>(),), islice(it, size - <span class="number">1</span>)))</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>l = [<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="string">&quot;e&quot;</span>, <span class="string">&quot;f&quot;</span>, <span class="string">&quot;g&quot;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> chunk <span class="keyword">in</span> chunks(l, <span class="number">3</span>, <span class="built_in">tuple</span>):...</span><br><span class="line">        <span class="built_in">print</span> chunk...</span><br><span class="line">(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>)</span><br><span class="line">(<span class="string">&quot;d&quot;</span>, <span class="string">&quot;e&quot;</span>, <span class="string">&quot;f&quot;</span>)</span><br><span class="line">(<span class="string">&quot;g&quot;</span>,)</span><br></pre></td></tr></table></figure>



<h1 id="python协程"><a href="#python协程" class="headerlink" title="python协程"></a>python协程</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/company-information/153421.html">谈谈Python协程技术的演进谈谈Python协程技术的演进</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jishuwen.com/d/2qPt">Python协程从入门到放弃到死亡到重生</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.writeathink.cn/2018/03/12/asyncio/">Python协程的演化-从yield&#x2F;send到async&#x2F;await</a></p>
</blockquote>
<p>协程的实现方式有很多，这里我们来列举三种基本方式</p>
<ul>
<li>利用 <code>yield</code> 来实现协程</li>
<li>利用 <code>greenlet</code> 模块实现</li>
<li>利用 <code>gevent</code> 模块实现</li>
</ul>
<p>并行与并发</p>
<ul>
<li><strong>并行</strong>是指两个或者多个事件在<font color="#00CED1">同一时刻发生</font>，通常是当系统有一个以上CPU或CPU核心时，才有可能并行<ul>
<li>两个或者多个事件、线程并步<strong>抢占CPU资源</strong></li>
</ul>
</li>
<li><strong>并发</strong>是指两个或者多个事件在<font color="#9400D3">同一时间间隔内发生</font><ul>
<li>在一定时间间隔内，有多个程序在执行，但在<strong>同一时刻，只有一个程序在执行</strong></li>
</ul>
</li>
</ul>
<h2 id="生成器和协程"><a href="#生成器和协程" class="headerlink" title="生成器和协程"></a>生成器和协程</h2><blockquote>
<p>协程的概念</p>
</blockquote>
<p>协程通过允许多个入口点在某些位置暂停和恢复执行来概括用于非抢占式多任务的子程序</p>
<p>yield 关键字已经可以暂停执行，如果在暂停后有方法把一些值发送回到暂停窒息的函数中，那么便就可以理解为协程</p>
<p>添加了<strong>把东西发回已经暂停的生成器中</strong>的方法，这个方法就是 send()</p>
<blockquote>
<p>生成器和协程</p>
</blockquote>
<p>从语法上讲，生成器是一个带yield语句的函数。协程，又称微线程，纤程，英文Coroutine</p>
<p>从某些角度来理解，协程其实就是一个可以暂停执行的函数，并且可以恢复继续执行</p>
<p>生成器和协程都是通过 python 中 yield 的关键字实现的</p>
<blockquote>
<p>next()和send()</p>
</blockquote>
<p>生成器只调用 next 来不断的生成数据，而协程会调用 next 和 send 来返回结果和接收参数</p>
<p>与<code>.__next__()</code> 方法一样，<code>.send()</code> 方法致使生成器前进到下一个 <code>yield</code> 语句</p>
<p>不过<code>.send()</code> 方法还允许使用生成器的客户把数据发给自己，即不管传给 <code>.send()</code> 方法什么参数，那个参数都会成为生成器函数定义体中对应的 <code>yield</code> 表达式的值</p>
<p>也就是说，<code>.send()</code> 方法允许在客户代码和生成器之间双向交换数据</p>
<p>而 <code>.__next__()</code> 方法只允许客户从生成器中获取数据</p>
<p>Python 新引入的 <code>yield from</code> 句法允许生成器或协程把工作委托给第三方完成，这样就无需嵌套 <code>for</code> 循环作为变通了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random,time</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stupid_fib</span>(<span class="params">n</span>):</span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    a = <span class="number">0</span></span><br><span class="line">    b = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> index &lt; n:</span><br><span class="line">        sleep_cnt = <span class="keyword">yield</span> b</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;let me think &#123;0&#125; secs&#x27;</span>.<span class="built_in">format</span>(sleep_cnt))</span><br><span class="line">        time.sleep(sleep_cnt)</span><br><span class="line">        a, b = b, a + b</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span>*<span class="number">10</span> + <span class="string">&#x27;test yield send&#x27;</span> + <span class="string">&#x27;-&#x27;</span>*<span class="number">10</span>)</span><br><span class="line">N = <span class="number">5</span></span><br><span class="line">sfib = stupid_fib(N)</span><br><span class="line">fib_res = <span class="built_in">next</span>(sfib)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="built_in">print</span>(fib_res)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        fib_res = sfib.send(random.uniform(<span class="number">0</span>, <span class="number">0.5</span>))</span><br><span class="line">    <span class="keyword">except</span> StopIteration:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">----------test <span class="keyword">yield</span> send----------</span><br><span class="line"><span class="number">1</span></span><br><span class="line">let me think <span class="number">0.2438615286011866</span> secs</span><br><span class="line"><span class="number">1</span></span><br><span class="line">let me think <span class="number">0.027476256830278822</span> secs</span><br><span class="line"><span class="number">2</span></span><br><span class="line">let me think <span class="number">0.09717699872403579</span> secs</span><br><span class="line"><span class="number">3</span></span><br><span class="line">let me think <span class="number">0.017161862262742633</span> secs</span><br><span class="line"><span class="number">5</span></span><br><span class="line">let me think <span class="number">0.3313821890336833</span> secs</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中 next(sfib) 相当于 sfib.send(None)，可以使得 sfib 运行至第一个 yield 处返回</p>
<p>后续将一个随机的秒数发送给 sfib ，作为当前中断的 yield 表达式的返回值</p>
<blockquote>
<p>yield 表达式的作用包含了三个步骤：</p>
</blockquote>
<ol>
<li>向函数外抛出值</li>
<li>暂停，等待 next() 或 send() 恢复</li>
<li>赋值，接受 send 发送过来的数据</li>
</ol>
<p>需要注意的是，在使用 send(None) 或者 next() 预激生成器函数，并执行到第一个 yield 语句结束的位置时，实际程序只执行了1、2两步，程序返回了值，并暂停，并没有执行第三步去赋值。在后续的循环中，才会进行赋值。</p>
<blockquote>
<p>生成器对象有 send 、throw 和 close 方法，这三个方法的作用分别是：</p>
</blockquote>
<ul>
<li>发送数据给生成器并赋值给 yield 语句</li>
<li>向生成器中抛入异常由生成器内部处理</li>
<li>终止生成器</li>
</ul>
<p> 这三个方法使得生成器进化成协程</p>
<h2 id="协程状态"><a href="#协程状态" class="headerlink" title="协程状态"></a>协程状态</h2><blockquote>
<p>协程有四种存在状态：</p>
</blockquote>
<ul>
<li>GEN_CREATED 创建完成，等待执行</li>
<li>GEN_RUNNING 解释器正在执行（这个状态在下面的示例程序中无法看到）</li>
<li>GEN_SUSPENDED 在 yield 表达式处暂停</li>
<li>GEN_CLOSE 执行结束，生成器停止</li>
</ul>
<p>可以使用 <code>inspect.getgeneratorstate</code> 方法查看协程的当前状态</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">202</span>]: <span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line">In [<span class="number">203</span>]: <span class="keyword">def</span> <span class="title function_">generator</span>():</span><br><span class="line">     ...:     i = <span class="string">&#x27;激活生成器&#x27;</span></span><br><span class="line">     ...:     <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">     ...:         <span class="keyword">try</span>:</span><br><span class="line">     ...:             value = <span class="keyword">yield</span> i</span><br><span class="line">     ...:         <span class="keyword">except</span> ValueError:</span><br><span class="line">     ...:             <span class="built_in">print</span>(<span class="string">&#x27;OVER&#x27;</span>)</span><br><span class="line">     ...:         i = value</span><br><span class="line">     ...:</span><br><span class="line"></span><br><span class="line">In [<span class="number">204</span>]: g = generator()  <span class="comment"># 1</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">205</span>]: inspect.getgeneratorstate(g)  <span class="comment"># 2</span></span><br><span class="line">Out[<span class="number">205</span>]: <span class="string">&#x27;GEN_CREATED&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">206</span>]: <span class="built_in">next</span>(g)  <span class="comment"># 3</span></span><br><span class="line">Out[<span class="number">206</span>]: <span class="string">&#x27;激活生成器&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">207</span>]: inspect.getgeneratorstate(g)</span><br><span class="line">Out[<span class="number">207</span>]: <span class="string">&#x27;GEN_SUSPENDED&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">208</span>]: g.send(<span class="string">&#x27;Hello Shiyanlou&#x27;</span>)  <span class="comment"># 4</span></span><br><span class="line">Out[<span class="number">208</span>]: <span class="string">&#x27;Hello Shiyanlou&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">209</span>]: g.throw(ValueError)  <span class="comment"># 5</span></span><br><span class="line">OVER</span><br><span class="line">Out[<span class="number">209</span>]: <span class="string">&#x27;Hello Shiyanlou&#x27;</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">210</span>]: g.close()  <span class="comment"># 6</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">211</span>]: inspect.getgeneratorstate(g)</span><br><span class="line">Out[<span class="number">211</span>]: <span class="string">&#x27;GEN_CLOSED&#x27;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>代码说明</p>
</blockquote>
<ol>
<li><p>创建生成器</p>
</li>
<li><p>查看生成器状态</p>
</li>
<li><p>这步操作叫做预激生成器（或协程），这是必须做的。在生成器创建完成后，需要将其第一次运行到 yield 语句处暂停</p>
</li>
<li><p>暂停状态的生成器可以使用 send 方法发送数据，此方法的参数就是 yield 表达式的值</p>
<p>也就是 yield 表达式等号前面的 value 变量的值变成 ‘Hello Shiyanlou’，继续向下执行完一次 while 循环，变量 i 被赋值，继续运行下一次循环，yield 表达式弹出变量 i</p>
</li>
<li><p>向生成器抛入异常，异常会被 try except 捕获，作进一步处理</p>
</li>
<li><p>close 方法终止生成器，异常不会被抛出</p>
</li>
</ol>
<p>因为生成器的调用方也就是程序员自己可以控制生成器的启动、暂停、终止，而且可以向生成器内部传入数据</p>
<p>所以这种生成器又叫做协程，generator 函数既可以叫做生成器函数，也可以叫协程函数，这是生成器向协程的过渡阶段</p>
<h2 id="yield-from"><a href="#yield-from" class="headerlink" title="yield from"></a>yield from</h2><blockquote>
<p>在 Python3.3 出现了 yield from 语法, yield from item 表达式从 item 中获得迭代器</p>
</blockquote>
<p>yield from 可以代替 for 循环，使得代码更为精炼，yield from 后面需要加的是可迭代对象</p>
<ul>
<li><code>yield from i</code> 完全代替了内层的 <code>for</code> 循环。而且代码读起来更顺畅，不过感觉更像是语法糖</li>
<li>除了代替循环之外，<code>yield from</code> 还会创建通道，把内层生成器直接与外层生成器的客户端联系起来</li>
<li>把生成器当成协程使用时，这个通道特别重要，不仅能为客户端代码生成值，还能使用客户端代码提供的值</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yield from</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">first_gen</span>():</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="string">&quot;AB&quot;</span>:</span><br><span class="line">        <span class="keyword">yield</span> c</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">3</span>):</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(first_gen()))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">second_gen</span>():</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> <span class="string">&quot;AB&quot;</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(second_gen()))</span><br><span class="line"></span><br><span class="line">[<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">[<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>]</span><br></pre></td></tr></table></figure>

<p>当 yiled from 后面加上一个生成器之后，就实现了生成的嵌套。实现生成器的嵌套，不一定要使用 yield from</p>
<p>但它可以让我们避免让自己处理各种料想不到的异常，如果自己去实现，会加大编码的难度。</p>
<blockquote>
<p>yield from 的主要功能是打开双向通道，把最外层的调用与最内层的子生成器连接起来</p>
<p>这样二者就可以直接发送和产出值，还可以直接穿入异常</p>
</blockquote>
<p><img src="../../../../img/3.python%E5%8D%8F%E7%A8%8B/VjuAreZ.jpg" alt="img"><br>委派生成器在 yied from 表达式处暂停时，调用方可以直接把数据发给子生成器</p>
<p>子生成器再把产出值发给调用方，子生成器返回之后，解释器会抛出 StopIteration 异常</p>
<p>委托生成器的作用就是：在调用方与子生成器之间建立一个双向通道</p>
<p><strong>为什么一定要使用 yield from 语句呢</strong>：在使用 yiled from 语句时，语句为我们已经处理了很多的异常</p>
<h2 id="yield-from-获取返回值"><a href="#yield-from-获取返回值" class="headerlink" title="yield from 获取返回值"></a>yield from 获取返回值</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_27825451/article/details/85244237?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522161362921316780274135975%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&request_id=161362921316780274135975&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_v1~rank_blog_v1-2-85244237.pc_v1_rank_blog_v1&utm_term=python%E5%8D%8F%E7%A8%8B%E7%B3%BB%E5%88%97">python协程系列（三）——yield from原理详解</a></p>
</blockquote>
<p>在使用yield生成器的时候，如果使用for语句去迭代生成器，则不会显式的出发StopIteration异常，而是自动捕获StopIteration异常</p>
<p>所以如果遇到return，只是会终止迭代，而不会触发异常，故而也就没办法获取return的值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">my_generator</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        <span class="keyword">if</span> i==<span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;我被迫中断了&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">generator</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> generator:  <span class="comment">#不会显式触发异常，故而无法获取到return的值</span></span><br><span class="line">            <span class="built_in">print</span>(i)</span><br><span class="line">    <span class="keyword">except</span> StopIteration <span class="keyword">as</span> exc:</span><br><span class="line">        <span class="built_in">print</span>(exc.value)</span><br><span class="line"></span><br><span class="line">g=my_generator()  <span class="comment">#调用</span></span><br><span class="line">main(g)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">运行结果为：</span></span><br><span class="line"><span class="string">0</span></span><br><span class="line"><span class="string">1</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>从上面的例子可以看出，for迭代语句不会显式触发异常，故而无法获取到return的值</p>
<p>迭代到2的时候遇到return语句，隐式的触发了StopIteration异常，就终止迭代了，但是在程序中不会显示出来</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">my_generator</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        <span class="keyword">if</span> i==<span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;我被迫中断了&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">generator</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">next</span>(generator))   <span class="comment">#每次迭代一个值，则会显式出发StopIteration</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">next</span>(generator))</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">next</span>(generator))</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">next</span>(generator))</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">next</span>(generator))</span><br><span class="line">    <span class="keyword">except</span> StopIteration <span class="keyword">as</span> exc:</span><br><span class="line">        <span class="built_in">print</span>(exc.value)     <span class="comment">#获取返回的值</span></span><br><span class="line"></span><br><span class="line">g=my_generator()</span><br><span class="line">main(g)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">运行结果为：</span></span><br><span class="line"><span class="string">0</span></span><br><span class="line"><span class="string">1</span></span><br><span class="line"><span class="string">我被迫中断了</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>现在我们使用yield from来完成上面的同样的功能</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">my_generator</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        <span class="keyword">if</span> i==<span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;我被迫中断了&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">wrap_my_generator</span>(<span class="params">generator</span>):  <span class="comment">#定义一个包装“生成器”的生成器，它的本质还是生成器</span></span><br><span class="line">    result = <span class="keyword">yield</span> <span class="keyword">from</span> generator    <span class="comment">#自动触发StopIteration异常，并且将return的返回值赋值给yield from表达式的结果</span></span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">generator</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> generator:</span><br><span class="line">        <span class="built_in">print</span>(j)</span><br><span class="line"></span><br><span class="line">g = my_generator()</span><br><span class="line">wrap_g = wrap_my_generator(g)</span><br><span class="line">main(wrap_g)  <span class="comment">#调用</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">运行结果为：</span></span><br><span class="line"><span class="string">0</span></span><br><span class="line"><span class="string">1</span></span><br><span class="line"><span class="string">我被迫中断了</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>从上面的比较可以看出，yield from具有以下几个特点：</p>
</blockquote>
<ul>
<li>调用方—&gt;生成器函数(协程函数)</li>
<li>调用方—&gt;生成器包装函数—&gt;生成器函数(协程函数)</li>
<li>return返回的值或者是StopIteration的value 属性的值变成 yield from 表达式的值，即上面的result</li>
</ul>
<h1 id="greenlet-和-gevent"><a href="#greenlet-和-gevent" class="headerlink" title="greenlet 和 gevent"></a>greenlet 和 gevent</h1><p>greenlet可以实现协程，不过每一次都要人为去指向下一个该执行的协程</p>
<p>greenlet 可以从一个协程切换到任意其他协程，但必须保证 greenlet 的正常结束，在协程之间的任意切换很容易出现问题</p>
<p>greelet 是 Stackless 发展来的 Cpython 扩展包， greelet 是底层实现了原生协程的C扩展库</p>
<p><img src="../../../../img/3.python%E5%8D%8F%E7%A8%8B/QFv6ZrY.jpg" alt="img"></p>
<h2 id="greenlet"><a href="#greenlet" class="headerlink" title="greenlet"></a>greenlet</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 greenlet 实现的 生产者-消费者 模型：</span></span><br><span class="line"><span class="comment"># greenlet 的价值在于高性能的原生协程，且语义更加明确、显式切换，执行到 switch 时就切换程序</span></span><br><span class="line"><span class="comment"># 直接将函数包装成协程，可以保留原代码的风格</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基于greenlet的生产者消费者协程</span></span><br><span class="line"><span class="keyword">from</span> greenlet <span class="keyword">import</span> greenlet</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Producer</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        item = random.randint(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;生产&lt;&#123;&#125;&gt;中...&quot;</span>.<span class="built_in">format</span>(item))</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        c.switch(item)  <span class="comment"># 切换到消费者，并将item传入。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Consumer</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        item = p.switch()  <span class="comment"># 切换到生产者。等待生产者传递参数item</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;消费&lt;&#123;&#125;&gt;中..&quot;</span>.<span class="built_in">format</span>(item))</span><br><span class="line"></span><br><span class="line">c = greenlet(Consumer)  <span class="comment"># 将普通函数编程协程</span></span><br><span class="line">p = greenlet(Producer)  <span class="comment"># 同理</span></span><br><span class="line">c.switch()  <span class="comment"># 启动协程，Consumer先执行</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">从consumer开始执行，执行到item=p.switch()时，程序切换到producer，并等待传参</span></span><br><span class="line"><span class="string">producer得到执行权后，生成一个item,并往下执行代码</span></span><br><span class="line"><span class="string">当producer执行到c.switch(item)时，程序携带传递的item切换到consumer,</span></span><br><span class="line"><span class="string">consumer继续往下执行，直到下一次运行到p.switch时，交出执行权，切换到producer，重复以上过程</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="gevent"><a href="#gevent" class="headerlink" title="gevent"></a>gevent</h2><p>gevent 是实现协程的第三方库，通过封装 greenlet，epoll 回调编程模式，生成器协程实现</p>
<p>当遇到 IO 操作时，就自动切换到其他协程，等到 IO 操作完成，再在适当的时候切换回来继续执行</p>
<p>gevent 会自动切换协程，就保证总有协程在执行，而不是等待 IO</p>
<p>由于切换实在 IO 操作时自动完成，所以 gevent 需要修改 Python 的自带的一些保准库，这一过程在启动时通过 monkey patch 完成</p>
<p>gevent的价值在于它的使用基于epoll的libev来避开阻塞；使用基于gevent的高效协程，来切换执行</p>
<p>只在遇到阻塞的时候切换，没有轮询和线程开销</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot; gevent: 通过greenlet实现协程，核心就是遇到IO操作，会自动切换到其他协程 &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将python标准库中的一些阻塞操作变为非阻塞</span></span><br><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey;monkey.patch_all()</span><br><span class="line"><span class="comment"># 使用猴子补丁要写在第一行</span></span><br><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test1</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;test1&quot;</span>)</span><br><span class="line">    gevent.sleep(<span class="number">0</span>)  <span class="comment"># 模拟耗时操作</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;test11&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test2</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;test2&quot;</span>)</span><br><span class="line">    gevent.sleep(<span class="number">0</span>)  <span class="comment"># 模拟耗时操作</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;test22&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># g1 = gevent.spawn(test1)  # 将函数封装成协程，并启动</span></span><br><span class="line"><span class="comment"># g2 = gevent.spawn(test2)</span></span><br><span class="line"><span class="comment"># gevent.joinall([g1, g2])</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># joinall() 阻塞当前流程，执行给定的greenlet(列表中的对象),等待程序执行完</span></span><br><span class="line"><span class="string"># spawn是启动协程，参数为函数名及其参数</span></span><br><span class="line"><span class="string">test1</span></span><br><span class="line"><span class="string">test2</span></span><br><span class="line"><span class="string">test11</span></span><br><span class="line"><span class="string">test22</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">代码执行test1,打印test1，遇到gevent.sleep(0)时切换程序，执行test2</span></span><br><span class="line"><span class="string">test()执行，打印test2，执行到gevent.sleep(0)时切换程序</span></span><br><span class="line"><span class="string">执行test1在gevent.sleep(0)后面的代码，直到再次遇到gevent时，切换程序</span></span><br><span class="line"><span class="string">然后在test2中，继续执行gevent后的代码，直到遇到gevent时，再次切换</span></span><br><span class="line"><span class="string">直到程序执行完毕</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="asyncio-coroutine"><a href="#asyncio-coroutine" class="headerlink" title="asyncio.coroutine"></a>asyncio.coroutine</h1><p>在 Python3.4 中加入了 asyncio 库，使得 Python 获得了事件循环的特性，但这个还是以生成器对象为基础</p>
<p>yield from 在 asyncio 模块中很常用，通过 asnyncio+生成器 ，我们可以实现这样一个异步的模型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">counttdown</span>(<span class="params">number, n</span>):</span><br><span class="line">    <span class="keyword">while</span> n &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;T-minus&quot;</span>, n, <span class="string">&quot;(&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(number))</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">        n -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">tasks = [</span><br><span class="line">    asyncio.ensure_future(counttdown(<span class="string">&quot;A&quot;</span>, <span class="number">2</span>)),</span><br><span class="line">    asyncio.ensure_future(counttdown(<span class="string">&quot;B&quot;</span>, <span class="number">5</span>)),</span><br><span class="line">]</span><br><span class="line">loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">loop.close()</span><br><span class="line"></span><br><span class="line">【out】</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;ipython-input-2-cff1e6420e75&gt;&quot;</span>, line <span class="number">15</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">  File <span class="string">&quot;S:\Anaconda3\lib\asyncio\base_events.py&quot;</span>, line <span class="number">555</span>, <span class="keyword">in</span> run_until_complete</span><br><span class="line">    self.run_forever()</span><br><span class="line">  File <span class="string">&quot;S:\Anaconda3\lib\asyncio\base_events.py&quot;</span>, line <span class="number">510</span>, <span class="keyword">in</span> run_forever</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;This event loop is already running&#x27;</span>)</span><br><span class="line">RuntimeError: This event loop <span class="keyword">is</span> already running</span><br><span class="line"></span><br><span class="line">T-minus <span class="number">2</span> (A)</span><br><span class="line">T-minus <span class="number">5</span> (B)</span><br><span class="line">T-minus <span class="number">1</span> (A)</span><br><span class="line">T-minus <span class="number">4</span> (B)</span><br><span class="line">T-minus <span class="number">3</span> (B)</span><br><span class="line">T-minus <span class="number">2</span> (B)</span><br><span class="line">T-minus <span class="number">1</span> (B)</span><br></pre></td></tr></table></figure>

<p>这里 asyncio.coroutine 装饰器是用来标记这个函数是一个协程，因为 asyncio 要求所有用作协程的生成器必须由 asyncio.coroutine 装饰</p>
<p>这段代码中，事件循环会启动两个 countdown() 协程，它们会一直执行，知道遇到 yield from asyncio.sleep() ，暂停执行，并将一个 async.Future 对象返回给事件循环</p>
<p>事件循环会监控这个 asyncio.Future 对象，一旦执行完成后，会将这个 Future 的执行结果返回给刚刚因为这个 Futur e暂停的协程，并且继续执行原协程</p>
<blockquote>
<p>event_loop 事件循环：</p>
</blockquote>
<p>程序开启一个无限的循环，程序员会把一些函数注册到事件循环上。当满足事件发生的时候，调用相应的协程函数</p>
<p>coroutine 协程：协程对象，指一个使用async关键字定义的函数，它的调用不会立即执行函数，而是会返回一个协程对象</p>
<p>协程对象需要注册到事件循环，由事件循环调用</p>
<p>task 任务：一个协程对象就是一个原生可以挂起的函数，任务则是对协程进一步封装，其中包含任务的各种状态</p>
<p>协程对象不能直接运行，在注册事件循环的时候，其实是 run_until_complete 方法将协程包装成一个任务（ task ）对象</p>
<p>task 对象是 Future 的子类，保存了协程运行后的状态，用于未来获取协程的结果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">在上面的代码中， asyncio.sleep 中，创建了一个 Futrure 对象，作为更内层的协程对象，通过 <span class="keyword">yield</span> <span class="keyword">from</span> 交给了事件循环，而 Future 是一个实现了 __iter__ 对象的生成器。</span><br><span class="line"><span class="meta">@coroutine</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sleep</span>(<span class="params">delay, result=<span class="literal">None</span>, *, loop=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Coroutine that completes after a given time (in seconds).&quot;&quot;&quot;</span></span><br><span class="line">    future = futures.Future(loop=loop)</span><br><span class="line">    h = future._loop.call_later(delay,</span><br><span class="line">                                future._set_result_unless_cancelled, result)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">yield</span> <span class="keyword">from</span> future)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        h.cancel()</span><br><span class="line"></span><br><span class="line"> <span class="keyword">class</span> <span class="title class_">Future</span>:</span><br><span class="line"><span class="comment">#blabla...</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.done():</span><br><span class="line">            self._blocking = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">yield</span> self  <span class="comment"># This tells Task to wait for completion.</span></span><br><span class="line">        <span class="keyword">assert</span> self.done(), <span class="string">&quot;yield from wasn&#x27;t used with future&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.result()  <span class="comment"># May raise too.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当协程 yield from asyncio.sleep 时，事件循环其实是与 Future 对象建立了联系。程序运行结果如下：</span></span><br><span class="line">T-minus <span class="number">2</span> (A)</span><br><span class="line">T-minus <span class="number">5</span> (B)</span><br><span class="line">T-minus <span class="number">1</span> (A)</span><br><span class="line">T-minus <span class="number">4</span> (B)</span><br><span class="line">T-minus <span class="number">3</span> (B)</span><br><span class="line">T-minus <span class="number">2</span> (B)</span><br><span class="line">T-minus <span class="number">1</span> (B)</span><br></pre></td></tr></table></figure>

<h1 id="async-和-await"><a href="#async-和-await" class="headerlink" title="async 和 await"></a>async 和 await</h1><p>在 Python3.5 中引入了 async 和 await ，可以将它们理解为 asyncio.coroutine &#x2F; yield from 的完美替身， async&#x2F;await 让协程表面上独立于生成器而存在，将细节隐藏于 asyncio 模块之下。使用 await 可以针对耗时的操作进行挂起，类似于生成器里的 yield 一样，使函数让出控制权</p>
<p>协程遇到 await ，事件循环挂起该协程，直到其他协程也挂起或者执行完毕，再进行下一个协程的执行。耗时的操作一般是一些 IO 操作，如网络请求，文件读取等</p>
<p>这里可以使用 asyncio.sleep 来进行模拟举例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">now = <span class="keyword">lambda</span>: time.time()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">do_some_work</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Waiting: &#x27;</span>, x)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(x)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Done after &#123;&#125;s&#x27;</span>.<span class="built_in">format</span>(x)</span><br><span class="line"></span><br><span class="line">start = now()</span><br><span class="line"></span><br><span class="line">coroutine1 = do_some_work(<span class="number">1</span>)</span><br><span class="line">coroutine2 = do_some_work(<span class="number">2</span>)</span><br><span class="line">coroutine3 = do_some_work(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">tasks = [</span><br><span class="line">    asyncio.ensure_future(coroutine1),</span><br><span class="line">    asyncio.ensure_future(coroutine2),</span><br><span class="line">    asyncio.ensure_future(coroutine3)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> task <span class="keyword">in</span> tasks:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Task ret: &#x27;</span>, task.result())</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;TIME: &#x27;</span>, now() - start)</span><br><span class="line"></span><br><span class="line">Waiting:  <span class="number">1</span></span><br><span class="line">Waiting:  <span class="number">2</span></span><br><span class="line">Waiting:  <span class="number">4</span></span><br><span class="line">Task ret:  Done after 1s</span><br><span class="line">Task ret:  Done after 2s</span><br><span class="line">Task ret:  Done after 4s</span><br><span class="line">TIME:  <span class="number">4.003541946411133</span></span><br></pre></td></tr></table></figure>

<p>在 sleep 的时候，使用 await 让出控制权。当遇到阻塞调用的函数的时候，使用 await 方法将协程的控制权让出，以便 loop 调用其他的协程</p>
<p>注意的区别是： await 接受的对象必须是一个 awaitable 的对象，所谓 awaitable 的对象，就是一个实现了 <strong>await()</strong> 方法的对象，而且这个方法必须返回一个不是协程的迭代器</p>
<p>在 Python3.6 中， yield 和 await 也可以在同一个函数中使用，初次之外，也可以在列表推导等地方使用 async for 或 await 语法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">result = [i <span class="keyword">async</span> <span class="keyword">for</span> i <span class="keyword">in</span> aiter() <span class="keyword">if</span> i % <span class="number">2</span>]</span><br><span class="line">result = [<span class="keyword">await</span> func() <span class="keyword">for</span> fun <span class="keyword">in</span> funcs <span class="keyword">if</span> <span class="keyword">await</span> condition()]</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(y):</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(x)</span><br></pre></td></tr></table></figure>

<h1 id="协程与异步"><a href="#协程与异步" class="headerlink" title="协程与异步"></a>协程与异步</h1><p>与多线程编程不同的是，多个协程总是运行在同一个线程中，一旦其中的一个协程发生阻塞行为，进而所有的协程都无法继续运行</p>
<p>例如在我们进行爬虫编写时，习惯使用 requests 库，而这个库就是阻塞的</p>
<p>尝试使用协程的方式进行编写：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"> </span><br><span class="line">start = time.time()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">return</span> requests.get(url)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">request</span>():</span><br><span class="line">    url = <span class="string">&#x27;http://127.0.0.1:5000&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Waiting for&#x27;</span>, url)</span><br><span class="line">    response = <span class="keyword">await</span> get(url)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Get response from&#x27;</span>, url, <span class="string">&#x27;Result:&#x27;</span>, response.text)</span><br><span class="line"> </span><br><span class="line">tasks = [asyncio.ensure_future(request()) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line"> </span><br><span class="line">end = time.time()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Cost time:&#x27;</span>, end - start)</span><br><span class="line"></span><br><span class="line">Waiting <span class="keyword">for</span> http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span></span><br><span class="line">Get response <span class="keyword">from</span> http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span> Result: Hello!</span><br><span class="line">Waiting <span class="keyword">for</span> http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span></span><br><span class="line">Get response <span class="keyword">from</span> http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span> Result: Hello!</span><br><span class="line">Waiting <span class="keyword">for</span> http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span></span><br><span class="line">Get response <span class="keyword">from</span> http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span> Result: Hello!</span><br><span class="line">Waiting <span class="keyword">for</span> http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span></span><br><span class="line">Get response <span class="keyword">from</span> http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span> Result: Hello!</span><br><span class="line">Waiting <span class="keyword">for</span> http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span></span><br><span class="line">Get response <span class="keyword">from</span> http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span> Result: Hello!</span><br><span class="line">Cost time: <span class="number">15.134317874908447</span></span><br></pre></td></tr></table></figure>

<p>而不使用协程，使用普通方式，也是这个时间。为什么会这样呢，究其原因是 requests 并不支持异步操作。在运行时阻塞并未挂起</p>
<p>另外 await 后面所跟的对象必须是：一个原生 coroutine 对象，一个由 types.coroutine 装饰的生成器，这个生成器可以返回 coroutine 对象</p>
<p>而 requests 返回的对象不符合上述条件。为了程序运行不报错，上面代码在 await 时对 requsts 进行了一次 async 函数的包装，但是它并不是“原生的coroutine对象”，因此也就不能真正异步了</p>
<p>可以通过使用实现了异步的 aiohttp 或者 Trip 库改写上述爬虫</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> spider_normal <span class="keyword">import</span> targets, show_results</span><br><span class="line"></span><br><span class="line">final_results = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_content</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> resp:</span><br><span class="line">            content = <span class="keyword">await</span> resp.read()</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">len</span>(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">spider</span>(<span class="params">url</span>):</span><br><span class="line">    length = <span class="keyword">await</span> get_content(url)</span><br><span class="line">    final_results[url] = length</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    cor = [spider(url) <span class="keyword">for</span> url <span class="keyword">in</span> targets]</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    result = loop.run_until_complete(asyncio.gather(*cor))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Use time: &#123;:.2f&#125;s&quot;</span>.<span class="built_in">format</span>(time.time() - start_time))</span><br><span class="line">    show_results(final_results)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;loop result: &quot;</span>, result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"># lightless @ LL-DESKTOP <span class="keyword">in</span> C:\Users\lightless\Desktop [<span class="number">22</span>:<span class="number">49</span>:<span class="number">11</span>] </span><br><span class="line">$ python .\spider_asyncio.py </span><br><span class="line">Use <span class="built_in">time</span>: <span class="number">2</span>.<span class="number">23</span>s </span><br><span class="line"><span class="function">Length:   227  <span class="title">URL:https</span>://<span class="title">www.baidu.com</span>/ </span></span><br><span class="line"><span class="function"><span class="title">Length</span>:  11759 <span class="title">URL:https</span>://<span class="title">www.zhihu.com</span>/ </span></span><br><span class="line"><span class="function"><span class="title">Length</span>:  40740 <span class="title">URL:https</span>://<span class="title">lightless.me</span>/<span class="title">archives</span>/<span class="title">python</span>-<span class="title">coroutine</span>-<span class="title">from</span>-<span class="title">start</span>-<span class="title">to</span>-<span class="title">boom.html</span> </span></span><br><span class="line"><span class="function"><span class="title">Length</span>: 150227 <span class="title">URL:https</span>://<span class="title">github.com</span>/<span class="title">aio</span>-<span class="title">libs</span> -<span class="title">engtn</span>: <span class="title">LO1</span> </span></span><br><span class="line"><span class="function"><span class="title">Length</span>:  59391 <span class="title">URL:https</span>://<span class="title">vww.python.org</span>/<span class="title">dev</span>/<span class="title">peps</span>/<span class="title">pep</span>-0380/ </span></span><br><span class="line"><span class="function"><span class="title">loop</span> <span class="title">result</span>: [<span class="title">True</span>,<span class="title">True</span>,<span class="title">True</span>,<span class="title">True</span>,<span class="title">True</span>] </span></span><br><span class="line"><span class="function"># <span class="title">lightless</span> @ <span class="title">LL</span>-<span class="title">DESKTOP</span> <span class="title">in</span> <span class="title">C</span>:\<span class="title">Users</span>\<span class="title">lightless</span>\<span class="title">Desktop</span> [22:49:15] </span></span><br><span class="line"><span class="function">$ <span class="title">python</span> .\<span class="title">spider_asyncio.py</span> </span></span><br><span class="line"><span class="function"><span class="title">Use</span> <span class="title">time</span>: 1.62<span class="title">s</span> </span></span><br><span class="line"><span class="function"><span class="title">Length</span>:  11759 <span class="title">URL:https</span>://<span class="title">www.zhihu.com</span>/ </span></span><br><span class="line"><span class="function"><span class="title">Length</span>:   227  <span class="title">URL:https</span>://<span class="title">www.baidu.com</span>/ </span></span><br><span class="line"><span class="function"><span class="title">Length</span>:  40830 <span class="title">URL:https</span>://<span class="title">lightless.me</span>/<span class="title">archives</span>/<span class="title">python</span>-<span class="title">coroutine</span>-<span class="title">from</span>-<span class="title">start</span>-<span class="title">to</span>-<span class="title">boom.html</span> </span></span><br><span class="line"><span class="function"><span class="title">Length</span>:  59391 <span class="title">URL:https</span>://<span class="title">ww.python.org</span>/<span class="title">dev</span>/<span class="title">peps</span>/<span class="title">pep</span>-0380/ </span></span><br><span class="line"><span class="function"><span class="title">Length</span>: 150227 <span class="title">URL:https</span>://<span class="title">github.com</span>/<span class="title">aio</span>-<span class="title">libs</span> </span></span><br><span class="line"><span class="function"><span class="title">loop</span> <span class="title">result</span>: [<span class="title">True</span>,<span class="title">True</span>,<span class="title">True</span>,<span class="title">True</span>,<span class="title">True</span>]</span></span><br><span class="line"><span class="function"># <span class="title">lightless</span> @ <span class="title">LL</span>-<span class="title">DESKTOP</span> <span class="title">in</span> <span class="title">C</span>:\<span class="title">Users</span>\<span class="title">lightless</span>\<span class="title">Desktop</span> [22:49:20] </span></span><br><span class="line"><span class="function">$ <span class="title">python</span> .\<span class="title">spider_asyncio.py</span> </span></span><br><span class="line"><span class="function"><span class="title">Use</span> <span class="title">time</span>: 1.59<span class="title">s</span> </span></span><br><span class="line"><span class="function"><span class="title">Length</span>:  11759 <span class="title">URL:https</span>://<span class="title">ww.zhihu.com</span>/ </span></span><br><span class="line"><span class="function"><span class="title">Length</span>:   227  <span class="title">URL:https</span>://<span class="title">www.baidu.com</span>/ </span></span><br><span class="line"><span class="function"><span class="title">Length</span>:  40629 <span class="title">URL:https</span>://<span class="title">lightless.me</span>/<span class="title">archives</span>/<span class="title">python</span>-<span class="title">coroutine</span>-<span class="title">from</span>-<span class="title">start</span>-<span class="title">to</span>-<span class="title">boom.html</span> </span></span><br><span class="line"><span class="function"><span class="title">Length</span>:  59391 <span class="title">URL:https</span>://<span class="title">ww.python.org</span>/<span class="title">dev</span>/<span class="title">peps</span>/<span class="title">pep</span>-0380/ </span></span><br><span class="line"><span class="function"><span class="title">Length</span>: 150219 <span class="title">URL:https</span>://<span class="title">github.com</span>/<span class="title">aio</span>-<span class="title">libs</span> <span class="title">loop</span> </span></span><br><span class="line"><span class="function"><span class="title">result</span>: [<span class="title">True</span>,<span class="title">True</span>,<span class="title">True</span>,<span class="title">True.True</span>] </span></span><br><span class="line"><span class="function"># <span class="title">lightless</span> @ <span class="title">LL</span>-<span class="title">DESKToP</span> <span class="title">in</span> <span class="title">C</span>:\<span class="title">Users</span>\<span class="title">lightless</span>\<span class="title">Desktop</span> [22:49:23] </span></span><br><span class="line"><span class="function">$ <span class="title">python</span> .\<span class="title">spider_asyncio.py</span> </span></span><br><span class="line"><span class="function"><span class="title">Use</span> <span class="title">time</span>: 4 70<span class="title">s</span> </span></span><br><span class="line"><span class="function"><span class="title">Length</span>:   227 <span class="title">URL:https</span>://<span class="title">www.baidu.com</span> </span></span><br><span class="line"><span class="function"><span class="title">Length</span>: 11759 <span class="title">URL:https</span>://<span class="title">www.zhihu.com</span>/ </span></span><br><span class="line"><span class="function"><span class="title">Lengtn</span>: 59391 <span class="title">URL:https</span>://<span class="title">www.python.org</span>/<span class="title">dev</span>/<span class="title">peps</span>/<span class="title">pep</span>-0380/ </span></span><br><span class="line"><span class="function"><span class="title">Length</span>:150218 <span class="title">URL:https</span>://<span class="title">github.com</span>/<span class="title">aio</span>-<span class="title">libs</span> </span></span><br><span class="line"><span class="function"><span class="title">Length</span>: 40740 <span class="title">URL:https</span>://<span class="title">lightless.me</span>/<span class="title">archives</span>/<span class="title">python</span>-<span class="title">coroutine</span>-<span class="title">from</span>-<span class="title">start</span>-<span class="title">to</span>-<span class="title">boom.html</span> </span></span><br><span class="line"><span class="function"><span class="title">loop</span> <span class="title">result</span>: [<span class="title">True.True</span>,<span class="title">True</span>,<span class="title">True.True</span>] </span></span><br><span class="line"><span class="function"># <span class="title">lightless</span> @ <span class="title">LL</span>-<span class="title">DESKTOP</span> <span class="title">in</span> <span class="title">C</span>:\<span class="title">Users</span>\<span class="title">lightless</span>\<span class="title">Desktop</span> [22:49:29] </span></span><br><span class="line"><span class="function">$ <span class="title">python</span> .\<span class="title">spider_asyncio.py</span> </span></span><br><span class="line"><span class="function"><span class="title">Use</span> <span class="title">time</span>: 1.85<span class="title">s</span> </span></span><br><span class="line"><span class="function"><span class="title">Length</span>:   227 <span class="title">URL:https</span>://<span class="title">www.baidu.com</span>/ </span></span><br><span class="line"><span class="function"><span class="title">Length</span>: 11759 <span class="title">URL:https</span>://<span class="title">www.zhihu.com</span>/ </span></span><br><span class="line"><span class="function"><span class="title">Length</span>: 40777 <span class="title">URL:https</span>://<span class="title">lightless.me</span>/<span class="title">archives</span>/<span class="title">python</span>-<span class="title">coroutine</span>-<span class="title">from</span>-<span class="title">start</span>-<span class="title">to</span>-<span class="title">boom.html</span> </span></span><br><span class="line"><span class="function"><span class="title">Length</span>: 59391 <span class="title">URL:https</span>://<span class="title">www.python.org</span>/<span class="title">dev</span>/<span class="title">peps</span>/<span class="title">pep</span>-0380/ </span></span><br><span class="line"><span class="function"><span class="title">Length</span>:150227 <span class="title">URL:httos</span>://<span class="title">github.com</span>/<span class="title">aio</span>-<span class="title">libs</span></span></span><br><span class="line"><span class="function"><span class="title">loop</span> <span class="title">result</span>:[<span class="title">True</span>,<span class="title">True</span>,<span class="title">True</span>,<span class="title">True</span>,<span class="title">True</span>] </span></span><br><span class="line"><span class="function"># <span class="title">lightless</span> @ <span class="title">LL</span>-<span class="title">DESKTOP</span> <span class="title">in</span> <span class="title">C</span>:\<span class="title">Users</span>\<span class="title">lightless</span>\<span class="title">Desktop</span> [22:49:32]</span></span><br></pre></td></tr></table></figure>
<link rel="stylesheet" href="/css/bilicard.css" type="text/css"></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://github.com/narutohyc">narutohyc</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://hycbook.github.io/hycBlog/article/56863.html">https://hycbook.github.io/hycBlog/article/56863.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/python/">python</a><a class="post-meta__tags" href="/tags/%E5%8D%8F%E7%A8%8B/">协程</a><a class="post-meta__tags" href="/tags/%E5%BC%82%E6%AD%A5/">异步</a><a class="post-meta__tags" href="/tags/%E8%BF%AD%E4%BB%A3%E5%99%A8/">迭代器</a><a class="post-meta__tags" href="/tags/itertools/">itertools</a><a class="post-meta__tags" href="/tags/yield/">yield</a><a class="post-meta__tags" href="/tags/asyncio/">asyncio</a></div><div class="post_share"><div class="social-share" data-image="https://images5.alphacoders.com/729/729952.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> Donate</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/hyc_wechat_%E6%94%B6%E6%AC%BE%E7%A0%81.png" target="_blank"><img class="post-qr-code-img" src="/img/hyc_wechat_%E6%94%B6%E6%AC%BE%E7%A0%81.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/hyc_alipay_%E6%94%B6%E6%AC%BE%E7%A0%81.png" target="_blank"><img class="post-qr-code-img" src="/img/hyc_alipay_%E6%94%B6%E6%AC%BE%E7%A0%81.png" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/article/16156.html"><img class="prev-cover" src="https://images.alphacoders.com/737/737770.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">python元编程</div></div></a></div><div class="next-post pull-right"><a href="/article/8258.html"><img class="next-cover" src="https://images5.alphacoders.com/729/729952.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">python基础知识</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/article/49959.html" title="python异步编程"><img class="cover" src="https://images6.alphacoders.com/735/735380.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-10</div><div class="title">python异步编程</div></div></a></div><div><a href="/article/4071.html" title="枚举类Enum"><img class="cover" src="https://images2.alphacoders.com/711/711907.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-10</div><div class="title">枚举类Enum</div></div></a></div><div><a href="/article/62278.html" title="pandas小记"><img class="cover" src="https://images.alphacoders.com/737/737770.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-10</div><div class="title">pandas小记</div></div></a></div><div><a href="/article/30791.html" title="numpy小记"><img class="cover" src="https://images7.alphacoders.com/729/729168.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-10</div><div class="title">numpy小记</div></div></a></div><div><a href="/article/27292.html" title="python_pipe包管道包学习"><img class="cover" src="https://images.alphacoders.com/737/737770.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-10</div><div class="title">python_pipe包管道包学习</div></div></a></div><div><a href="/article/65108.html" title="Python增强提案PEP"><img class="cover" src="https://images7.alphacoders.com/729/729168.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-10</div><div class="title">Python增强提案PEP</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div><div id="comment-switch"><span class="first-comment">Twikoo</span><span class="switch-btn"></span><span class="second-comment">Valine</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/%E5%85%BC%E4%B8%80%E5%A4%B4%E5%83%8F.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">narutohyc</div><div class="author-info__description">挑战时没有失败<br>放弃时才是失败</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">79</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">100</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/narutohyc"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/narutohyc" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/1832044043@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">兼一书虫博客成功上线啦~ 中秋折腾了三天，为了解决typora和hexo的资源路径问题，写了python去做路径的转换，好在最后成功处理，接下来可以专注写博客啦~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#python%E8%BF%AD%E4%BB%A3%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.</span> <span class="toc-text">python迭代对象</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E8%BF%AD%E4%BB%A3%E7%9A%84%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.1.</span> <span class="toc-text">可迭代的对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="toc-number">1.2.</span> <span class="toc-text">迭代器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%84%E7%BA%A6%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.</span> <span class="toc-text">规约函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%99%A8"><span class="toc-number">1.4.</span> <span class="toc-text">生成器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#itertools%E6%A8%A1%E5%9D%97"><span class="toc-number">1.5.</span> <span class="toc-text">itertools模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E9%99%90%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="toc-number">1.5.1.</span> <span class="toc-text">无限迭代器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%89%E9%99%90%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="toc-number">1.5.2.</span> <span class="toc-text">有限迭代器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E5%90%88%E7%94%9F%E6%88%90%E5%99%A8"><span class="toc-number">1.5.3.</span> <span class="toc-text">组合生成器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%8E%B0%E6%9C%89%E6%89%A9%E5%B1%95%E5%8A%9F%E8%83%BD"><span class="toc-number">1.5.4.</span> <span class="toc-text">使用现有扩展功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%89%A9%E5%B1%95"><span class="toc-number">1.5.5.</span> <span class="toc-text">自定义扩展</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#python%E5%8D%8F%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">python协程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%99%A8%E5%92%8C%E5%8D%8F%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">生成器和协程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%8F%E7%A8%8B%E7%8A%B6%E6%80%81"><span class="toc-number">2.2.</span> <span class="toc-text">协程状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#yield-from"><span class="toc-number">2.3.</span> <span class="toc-text">yield from</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#yield-from-%E8%8E%B7%E5%8F%96%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">2.4.</span> <span class="toc-text">yield from 获取返回值</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#greenlet-%E5%92%8C-gevent"><span class="toc-number">3.</span> <span class="toc-text">greenlet 和 gevent</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#greenlet"><span class="toc-number">3.1.</span> <span class="toc-text">greenlet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gevent"><span class="toc-number">3.2.</span> <span class="toc-text">gevent</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#asyncio-coroutine"><span class="toc-number">4.</span> <span class="toc-text">asyncio.coroutine</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#async-%E5%92%8C-await"><span class="toc-number">5.</span> <span class="toc-text">async 和 await</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%8F%E7%A8%8B%E4%B8%8E%E5%BC%82%E6%AD%A5"><span class="toc-number">6.</span> <span class="toc-text">协程与异步</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/article/14386.html" title="阿里云部署"><img src="https://images7.alphacoders.com/729/729309.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="阿里云部署"/></a><div class="content"><a class="title" href="/article/14386.html" title="阿里云部署">阿里云部署</a><time datetime="2022-09-12T02:02:25.000Z" title="Created 2022-09-12 10:02:25">2022-09-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/48230.html" title="Linux常用命令"><img src="https://images6.alphacoders.com/735/735380.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux常用命令"/></a><div class="content"><a class="title" href="/article/48230.html" title="Linux常用命令">Linux常用命令</a><time datetime="2022-09-12T02:02:25.000Z" title="Created 2022-09-12 10:02:25">2022-09-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/51084.html" title="github协作"><img src="https://images2.alphacoders.com/711/711907.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="github协作"/></a><div class="content"><a class="title" href="/article/51084.html" title="github协作">github协作</a><time datetime="2022-09-12T02:02:25.000Z" title="Created 2022-09-12 10:02:25">2022-09-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/44835.html" title="gitbook博客搭建"><img src="https://images2.alphacoders.com/711/711907.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="gitbook博客搭建"/></a><div class="content"><a class="title" href="/article/44835.html" title="gitbook博客搭建">gitbook博客搭建</a><time datetime="2022-09-12T02:02:25.000Z" title="Created 2022-09-12 10:02:25">2022-09-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/41279.html" title="重装系统"><img src="https://images6.alphacoders.com/735/735380.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="重装系统"/></a><div class="content"><a class="title" href="/article/41279.html" title="重装系统">重装系统</a><time datetime="2022-09-12T02:02:25.000Z" title="Created 2022-09-12 10:02:25">2022-09-12</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/%E9%A1%B5%E8%84%9A01.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2022 By narutohyc</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">I wish you to become your own sun, no need to rely on who's light.<br><p><a target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp;<a target="_blank" href="https://demo.jerryc.me/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Vervel-brightgreen?style=flat&logo=Vercel" title="本站采用双线部署，默认线路托管于Vercel"></a>&nbsp;<a target="_blank" href="https://github.com/"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">简</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="fa-solid fa-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="fa-solid fa-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="fa-solid fa-arrow-rotate-right"></i></div><div class="rightMenu-item" id="menu-home"><i class="fa-solid fa-house"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" href="/archives/"><i class="fa-solid fa-archive"></i><span>文章归档</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="fa-solid fa-folder-open"></i><span>文章分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="fa-solid fa-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuNormal"><a class="rightMenu-item menu-link" id="menu-radompage" href="/random/index.html"><i class="fa-solid fa-shoe-prints"></i><span>随便逛逛</span></a><div class="rightMenu-item" id="menu-translate"><i class="fa-solid fa-earth-asia"></i><span>繁简切换</span></div><div class="rightMenu-item" id="menu-darkmode"><i class="fa-solid fa-moon"></i><span>切换模式</span></div></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/algoliasearch-lite.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://vercel.hycbook.com',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://vercel.hycbook.com',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'ncn88uooQf0IO2rrGE7Vniwp-gzGzoHsz',
      appKey: 'Yghpzg1QfBMFJ0MxxHubVzKL',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: true
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Twikoo' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script defer src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script defer data-pjax src="/js/rightMenu.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script>window.$crisp = [];
window.CRISP_WEBSITE_ID = "561b80db-3f0f-45cb-b3b1-aae7355939e6";
(function () {
  d = document;
  s = d.createElement("script");
  s.src = "https://client.crisp.chat/l.js";
  s.async = 1;
  d.getElementsByTagName("head")[0].appendChild(s);
})();
$crisp.push(["safe", true])

if (false) {
  $crisp.push(["do", "chat:hide"])
  $crisp.push(["on", "chat:closed", function() {
    $crisp.push(["do", "chat:hide"])
  }])
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      $crisp.push(["do", "chat:show"])
      $crisp.push(["do", "chat:open"])

    });
  }
  chatBtnFn()
} else {
  if (false) {
    function chatBtnHide () {
      $crisp.push(["do", "chat:hide"])
    }
    function chatBtnShow () {
      $crisp.push(["do", "chat:show"])
    }
  }
}</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>